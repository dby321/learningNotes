# 微信小程序笔记

[微信小程序学习笔记，知识点全面概括总结](https://blog.csdn.net/m0_61663332/article/details/128490678)

[vue和微信小程序的区别、比较](https://segmentfault.com/a/1190000015684864)

[微信公众平台](https://mp.weixin.qq.com/)

## 1. 小程序简介

### 小程序与普通网页开发的区别

1. 运行环境不同 小程序运行在微信环境中
2. 开发模式不同 小程序有专门的开发工具
3. API不同 小程序中无法使用BOM和DOM，但可以使用微信全家桶

### 小程序的文件目录结构

[微信官方文档-指南-小程序代码构成](https://developers.weixin.qq.com/miniprogram/dev/framework/quickstart/code.html#JSON-%E9%85%8D%E7%BD%AE)

1. pages 所有小程序的页面文件夹
2. utils 工具性质的模块
3. app.js 整个小程序项目的入口文件
4. app.json 全局配置文件
5. app.wxss 全局样式文件
6. project.config.json 项目的配置文件
7. sitemap.json 页面是否允许被微信索引
8. .js 文件：页面脚本文件，存放页面的数据、事件处理函数等
9. .json 文件：当前页面的配置文件，配置窗口的外观
10. .wxml 文件：页面的模板结构文件，标签语言
11. .wxss 文件：样式表文件，样式语言

### app.json案例

JSON中不能写注释

```json
{
  "pages":[
    "pages/index/index",
    "pages/logs/logs"
  ],
  "window":{
    "backgroundTextStyle":"light",
    "navigationBarBackgroundColor": "#fff",
    "navigationBarTitleText": "WeChat",
    "navigationBarTextStyle":"black"
  }，
  "style":"v2",
  "sitemapLocation":"sitmap.json"
}
```

### project.config.json案例

本地设置和project.config.json一一对应

### sitemap.json案例

action为disallow时，不被微信搜索索引

```json
{
    "desc": "关于本文件的更多信息，请参考文档 https://developers.weixin.qq.com/miniprogram/dev/framework/sitemap.html",
    "rules": [{
    "action": "allow",
    "page": "*"
    }]
}
```

### 新建新页面

- 在app.json中的pages中增加一个page

- 调整页面顺序会切换页面首页

```json
{
  "pages":[
    "pages/index/index",
    "pages/logs/logs",
     "pages/list/list"
  ],
  "window":{
    "backgroundTextStyle":"light",
    "navigationBarBackgroundColor": "#fff",
    "navigationBarTitleText": "WeChat",
    "navigationBarTextStyle":"black"
  }，
  "style":"v2",
  "sitemapLocation":"sitmap.json"
}
```

## 2. 小程序代码组成

### 2.1 JSON配置

```json
{
  "pages":[
    "pages/index/index",
    "pages/logs/logs"
  ],
  "window":{
    "backgroundTextStyle":"light",
    "navigationBarBackgroundColor": "#fff",
    "navigationBarTitleText": "WeChat",
    "navigationBarTextStyle":"black"
  }，
  "style":"v2",
  "sitemapLocation":"sitmap.json"
}
```

### 2.2 WXML模板

#### 数据绑定

```html
<text data-test="{{test}}"> hello world</text>
<text>当前时间：{{time}}</text>
```

#### 逻辑语法

```html
<view> {{a + b}} + {{c}} + d </view>
<text>{{ a === 10? "变量 a 等于10": "变量 a 不等于10"}}</text>
```

#### 条件渲染

```html
<view wx:if="{{length > 5}}"> 1 </view>
<view wx:elif="{{length > 2}}"> 2 </view>
<view wx:else> 3 </view>
```

#### 控制隐藏

```html
<view hidden="{{flag}}">这是要隐藏的文字</view>
```

#### 列表渲染

> key绑定的值最好是唯一ID

```html
<view wx:for="{{array}}" wx:for-index="idx" wx:for-item="itemName"  wx:key="idx">
  {{idx}}: {{itemName.message}}
</view>

<view wx:for="{{array}}">
  {{index}}: {{item.message}}
</view>
```

#### 模板

```html
<template name="msgItem">
  <view>
    <text> {{index}}: {{msg}} </text>
    <text> Time: {{time}} </text>
  </view>
</template>


<template is="msgItem" data="{{...item}}"/>
```

```html
<template name="odd">
  <view> odd </view>
</template>


<template name="even">
  <view> even </view>
</template>


<block wx:for="{{[1, 2, 3, 4, 5]}}">
  <template is="{{item % 2 == 0 ? 'even' : 'odd'}}"/>
</block>
```

#### 引用

在 item.wxml 中定义了一个叫 item的 template ：

```html
<!-- item.wxml -->
<template name="item">
  <text>{{text}}</text>
</template>
```

在 index.wxml 中引用了 item.wxml，就可以使用 item模板：

```html
<import src="item.wxml"/>

<template is="item" data="{{text: 'forbar'}}"/>
```

#### 事件

```html
<button bindtap="noWork">明天不上班</button>
<button catchtap="noWork">明天不上班</button>  //阻止事件冒泡
```

##### target和currentTarget区别

这里需要注意的是target和currentTarget的区别，currentTarget为当前事件所绑定的组件，而target则是触发该事件的源头组件。

代码清单3-19 事件对象示例

```html
<!-- page.wxml -->
<view id="outer" catchtap="handleTap">
  <view id="inner">点击我</view>
</view>
// page.js
Page({
  handleTap: function(evt) {
       // 当点击inner节点时
    // evt.target 是inner view组件
       // evt.currentTarget 是绑定了handleTap的outer view组件
       // evt.type == “tap”
       // evt.timeStamp == 1542
       // evt.detail == {x: 270, y: 63}
       // evt.touches == [{identifier: 0, pageX: 270, pageY: 63, clientX: 270, clientY: 63}]
       // evt.changedTouches == [{identifier: 0, pageX: 270, pageY: 63, clientX: 270, clientY: 63}]
  }
})
```



## 3. 宿主系统

[微信官方文档-指南-小程序宿主环境](https://developers.weixin.qq.com/miniprogram/dev/framework/quickstart/framework.html)

小程序宿主环境包含的内容：

- 通信模型
- 运行机制
- 组件
- API

### 3.1 通信模型

首先，我们来简单了解下小程序的运行环境。小程序的运行环境分成`渲染层`和`逻辑层`，其中 `WXML 模板和 WXSS 样式工作在渲染层`，`JS 脚本工作在逻辑层`。

`小程序的渲染层和逻辑层分别由2个线程管理`：`渲染层的界面使用了WebView 进行渲染`；`逻辑层采用JsCore线程运行JS脚本`。一个小程序存在多个界面，所以渲染层存在多个WebView线程，这两个线程的通信会经由微信客户端（下文中也会采用Native来代指微信客户端）做中转，逻辑层发送网络请求也经由Native转发，小程序的通信模型下图所示。

![小程序通信模型](https://res.wx.qq.com/wxdoc/dist/assets/img/4-1.ad156d1c.png)

### 3.2 运行机制

- 小程序启动的过程：

  - 把小程序的代码包下载到本地

  - 解析 app.json 全局配置文件

  - 执行 app.js 小程序入口文件，调用 App() 创建小程序实例

  - 渲染小程序首页；小程序启动完成

- 某个页面渲染的过程：
  - 加载解析页面的 .json 配置文件
  - 加载页面的 .wxml 模板和 .wxss 样式
  - 执行页面的 .js 文件，调用 Page() 创建页面实例
  - 页面渲染完成

### 3.3 组件

[微信官方文档-组件](https://developers.weixin.qq.com/miniprogram/dev/component/)

视图组件(view / scroll-view滚动视图 / swiper 轮播图和 swiper-item)
基础内容：text文本组件、rich-text富文本组件、button组件、image组件、表单组件、导航组件、媒体组件、map地图组件、画布组件。

```html
<map bindmarkertap="markertap" longitude="广州经度" latitude="广州纬度"></map>
```

### 3.4 API

[微信官方文档-API](https://developers.weixin.qq.com/miniprogram/dev/api/)
