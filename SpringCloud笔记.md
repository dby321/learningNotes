

# SpringCloud

## å‚è€ƒèµ„æ–™

[W3CSchool-SpringCloudæ•™ç¨‹](https://www.w3cschool.cn/scchinese/)

## é±¼çš®çš„å»ºè®®

éšç€äº’è”ç½‘çš„å‘å±•ï¼Œé¡¹ç›®è¶Šæ¥è¶Šå¤æ‚ï¼Œå•æœºä¸”åºå¤§çš„å·¨çŸ³é¡¹ç›®å·²æ— æ³•æ»¡è¶³å¼€å‘ã€è¿ç»´ã€å¹¶å‘ã€å¯é æ€§ç­‰éœ€æ±‚ã€‚

å› æ­¤ï¼Œåå°æ¶æ„ä¸æ–­æ¼”è¿›ï¼Œå¯ä»¥å°†åºå¤§çš„é¡¹ç›®æ‹†åˆ†æˆä¸€ä¸ªä¸ªèŒè´£æ˜ç¡®ã€åŠŸèƒ½ç‹¬ç«‹çš„ç»†å°æ¨¡å—ï¼Œæ¨¡å—å¯ä»¥éƒ¨ç½²åœ¨å¤šå°æœåŠ¡å™¨ä¸Šï¼Œç›¸äº’é…åˆåä½œï¼Œæä¾›å®Œæ•´çš„ç³»ç»Ÿèƒ½åŠ›ã€‚

æ¢è¨€ä¹‹ï¼Œæƒ³åšå¤§å‹é¡¹ç›®ï¼Œè¿™å—å„¿ä¸€å®šè¦å¥½å¥½å­¦ï¼

#### [#](https://www.codefather.cn/javaå­¦ä¹ è·¯çº¿-by-ç¨‹åºå‘˜é±¼çš®/#çŸ¥è¯†-18)çŸ¥è¯†

##### [#](https://www.codefather.cn/javaå­¦ä¹ è·¯çº¿-by-ç¨‹åºå‘˜é±¼çš®/#dubbo)Dubbo

- æ¶æ„æ¼”è¿›
- RPC
- Zookeeper
- æœåŠ¡æä¾›è€…
- æœåŠ¡æ¶ˆè´¹è€…
- é¡¹ç›®æ­å»º
- ç›¸å…³æŠ€æœ¯ï¼šDubboXï¼ˆå¯¹ Dubbo çš„æ‰©å±•ï¼‰

##### [#](https://www.codefather.cn/javaå­¦ä¹ è·¯çº¿-by-ç¨‹åºå‘˜é±¼çš®/#ğŸŒ–-å¾®æœåŠ¡)ğŸŒ– å¾®æœåŠ¡

- å¾®æœåŠ¡æ¦‚å¿µ
- Spring Cloud æ¡†æ¶
  - å­çˆ¶å·¥ç¨‹
  - æœåŠ¡æ³¨å†Œä¸å‘ç°
  - æ³¨å†Œä¸­å¿ƒ Eurekaã€Zookeeperã€Consul
  - Ribbon è´Ÿè½½å‡è¡¡
  - Feign æœåŠ¡è°ƒç”¨
  - Hystrix æœåŠ¡é™æµã€é™çº§ã€ç†”æ–­
  - Resilience4j æœåŠ¡å®¹é”™
  - Gatewayï¼ˆZuulï¼‰å¾®æœåŠ¡ç½‘å…³
  - Config åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒ
  - åˆ†å¸ƒå¼æœåŠ¡æ€»çº¿
  - Sleuth + Zipkin åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª
- Spring Cloud Alibaba
  - Nacos æ³¨å†Œã€é…ç½®ä¸­å¿ƒ
  - OpenFeign æœåŠ¡è°ƒç”¨
  - Sentinel æµæ§
  - Seata åˆ†å¸ƒå¼äº‹åŠ¡

##### [#](https://www.codefather.cn/javaå­¦ä¹ è·¯çº¿-by-ç¨‹åºå‘˜é±¼çš®/#æ¥å£ç®¡ç†)æ¥å£ç®¡ç†

- Swagger æ¥å£æ–‡æ¡£
- Postman æ¥å£æµ‹è¯•
- ç›¸å…³æŠ€æœ¯ï¼šYApiã€ShowDoc

#### [#](https://www.codefather.cn/javaå­¦ä¹ è·¯çº¿-by-ç¨‹åºå‘˜é±¼çš®/#å­¦ä¹ å»ºè®®-19)å­¦ä¹ å»ºè®®

æ—¶é—´ä¸æ€¥çš„è¯ï¼Œå»ºè®®å…ˆä» Dubbo å­¦èµ·ï¼Œå¯¹åˆ†å¸ƒå¼ã€RPCã€å¾®æœåŠ¡æœ‰äº›åŸºæœ¬çš„äº†è§£ï¼Œå†å»é£Ÿç”¨ Spring Cloud å…¨å®¶æ¡¶ä¼šæ›´é¦™ã€‚å­¦å®Œ Spring Cloud å…¨å®¶æ¡¶åï¼Œå†å»å­¦ Spring Cloud Alibaba å°±å¾ˆç®€å•äº†ã€‚

è¿™éƒ¨åˆ†å†…å®¹çš„å­¦ä¹ ï¼ŒåŸç† + å®è·µéƒ½å¾ˆé‡è¦ï¼Œä¹Ÿä¸è¦è¢«å„ç§é«˜å¤§ä¸Šçš„è¯æ±‡å”¬ä½äº†ï¼Œéƒ½æ˜¯ä¸Šå±‚ï¼ˆåº”ç”¨å±‚ï¼‰çš„ä¸œè¥¿ï¼ŒåŸºæœ¬æ²¡æœ‰ä»€ä¹ˆç®—æ³•ï¼Œè·Ÿç€è§†é¢‘æ•™ç¨‹å­¦ï¼Œå…¶å®è¿˜æ˜¯å¾ˆå¥½ç†è§£çš„ã€‚

åˆ†å¸ƒå¼ç›¸å…³çŸ¥è¯†éå¸¸å¤šï¼Œä½†è¿™é‡Œä¸ç”¨åˆ»æ„å»èƒŒï¼Œå…ˆé€šè¿‡è§†é¢‘æ•™ç¨‹å®æˆ˜ä½¿ç”¨ä¸€äº›å¾®æœåŠ¡æ¡†æ¶ï¼Œä¹Ÿèƒ½å¯¹å…¶ä¸­çš„æ¦‚å¿µæœ‰åŸºæœ¬çš„äº†è§£ã€‚

å¤§å‚é¢è¯•çš„æ—¶å€™å¾ˆå°‘é—® Spring Cloud æ¡†æ¶çš„ç»†èŠ‚ï¼Œæ›´å¤šçš„æ˜¯å¾®æœåŠ¡ä»¥åŠå„ç»„ä»¶çš„ä¸€äº›æ€æƒ³ï¼Œæ¯”å¦‚ç½‘å…³çš„å¥½å¤„ã€æ¶ˆæ¯æ€»çº¿çš„å¥½å¤„ç­‰ã€‚

#### [#](https://www.codefather.cn/javaå­¦ä¹ è·¯çº¿-by-ç¨‹åºå‘˜é±¼çš®/#ç»å…¸é¢è¯•é¢˜-14)ç»å…¸é¢è¯•é¢˜

1. ä»€ä¹ˆæ˜¯å¾®æœåŠ¡ï¼Œæœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ
2. ä»€ä¹ˆæ˜¯æ³¨å†Œä¸­å¿ƒï¼Œèƒ½è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ

#### [#](https://www.codefather.cn/javaå­¦ä¹ è·¯çº¿-by-ç¨‹åºå‘˜é±¼çš®/#èµ„æº-18)èµ„æº

- é¡¹ç›®å®æˆ˜
  - [é¡¹ç›®å®æˆ˜ - é±¼çš®åŸåˆ›é¡¹ç›®æ•™ç¨‹ç³»åˆ— (opens new window)](https://yuyuanweb.feishu.cn/wiki/SePYwTc9tipQiCktw7Uc7kujnCd)ä¸­çš„ API å¼€æ”¾å¹³å°ã€åœ¨çº¿åˆ¤é¢˜ç³»ç»Ÿéƒ½è¿ç”¨äº†å¾®æœåŠ¡ï¼Œæ¨èå­¦ä¹ 
- è§†é¢‘
  - â­ï¸ é»‘é©¬ Spring Cloud è§†é¢‘æ•™ç¨‹ï¼š[https://www.bilibili.com/video/BV1kH4y1S7wz (opens new window)](https://www.bilibili.com/video/BV1kH4y1S7wz)ï¼ˆ11 å°æ—¶ï¼Œéå¸¸å‡ç»ƒï¼Œé€‚åˆå¿«é€Ÿå…¥é—¨ï¼‰
  - â­ï¸ å°šç¡…è°· Dubbo æ•™ç¨‹ï¼š[https://www.bilibili.com/video/BV1ns411c7jV(opens new window)](https://www.bilibili.com/video/BV1ns411c7jV)
  - å°šç¡…è°· SpringCloudï¼ˆHç‰ˆ&alibabaï¼‰æ¡†æ¶å¼€å‘æ•™ç¨‹ï¼ˆå¾®æœåŠ¡åˆ†å¸ƒå¼æ¶æ„ï¼‰ï¼š[https://www.bilibili.com/video/BV18E411x7eT (opens new window)](https://www.bilibili.com/video/BV18E411x7eT)ï¼ˆæŠŠå›½å¤–çš„ Spring Cloud å’Œå›½å†…çš„ Spring Cloud Alibaba ç»“åˆåœ¨ä¸€èµ·å¯¹æ¯”ç€å»è®²ï¼Œä¸»æµæŠ€æœ¯æ ˆã€çŸ¥è¯†ç‚¹éƒ½è®²åˆ°äº†ï¼Œå†…å®¹æ›´å…¨é¢ï¼‰
- æ–‡æ¡£
  - Apache Dubbo å®˜æ–¹æ–‡æ¡£ï¼š[https://dubbo.apache.org/zh/(opens new window)](https://dubbo.apache.org/zh/)
  - Spring Cloud Alibaba å®˜æ–¹æ–‡æ¡£ï¼š[https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md(opens new window)](https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md)
  - â­ Swagger æ•™å­¦æ–‡æ¡£ï¼š[https://doc.xiaominfo.com/ (opens new window)](https://doc.xiaominfo.com/)ï¼ˆè·Ÿç€å¿«é€Ÿå¼€å§‹ç›´æ¥ç”¨å°±å¥½äº†ï¼‰

## RestTemplate

https://www.baeldung-cn.com/rest-template

https://www.baeldung-cn.com/java-lombok-constructor-annotation

## 5. EurekaæœåŠ¡æ³¨å†Œä¸å‘ç°

### EurekaåŸºç¡€çŸ¥è¯†

#### ä»€ä¹ˆæ˜¯æœåŠ¡æ²»ç†

åœ¨ä¼ ç»Ÿçš„RPCè¿œç¨‹è°ƒç”¨æ¡†æ¶ä¸­ï¼Œç®¡ç†æ¯ä¸ªæœåŠ¡ä¸æœåŠ¡ä¹‹é—´ä¾èµ–å…³ç³»æ¯”è¾ƒå¤æ‚ï¼Œç®¡ç†æ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨æœåŠ¡æ²»ç†ï¼Œç®¡ç†æœåŠ¡ä¸æœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå¯ä»¥å®ç°æœåŠ¡è°ƒç”¨ã€è´Ÿè½½å‡è¡¡ã€å®¹é”™ç­‰ï¼Œå®ç°æœåŠ¡æ³¨å†Œä¸å‘ç°

#### ä»€ä¹ˆæ˜¯æœåŠ¡æ³¨å†Œ

Eurekaé‡‡ç”¨äº†CSçš„è®¾è®¡æ¶æ„ï¼ŒEureka Serverä½œä¸ºæœåŠ¡æ³¨å†ŒåŠŸèƒ½çš„æœåŠ¡å™¨ï¼Œä»–æ˜¯æœåŠ¡æ³¨å†Œä¸­å¿ƒã€‚è€Œç³»ç»Ÿä¸­å…¶ä»–å¾®æœåŠ¡ï¼Œä½¿ç”¨Eurekaçš„å®¢æˆ·ç«¯è¿æ¥åˆ°Eureka Serverå¹¶ç»´æŒ**å¿ƒè·³è¿æ¥**ã€‚è¿™æ ·ç³»ç»Ÿçš„ç»´æŠ¤äººå‘˜å°±å¯ä»¥é€šè¿‡Eureka Serveræ¥ç›‘æ§ç³»ç»Ÿä¸­å„ä¸ªå¾®æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚

åœ¨æœåŠ¡æ³¨å†Œä¸å‘ç°ä¸­ï¼Œæœ‰ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒï¼Œå½“æœåŠ¡å™¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šæŠŠå½“å‰è‡ªå·±æœåŠ¡å™¨çš„ä¿¡æ¯ï¼Œæ¯”å¦‚æœåŠ¡åœ°å€ã€é€šè®¯åœ°å€ç­‰ä»¥åˆ«åæ–¹æ³•æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒä¸Šã€‚å¦ä¸€æ–¹ï¼ˆæ¶ˆè´¹è€…|æœåŠ¡æä¾›è€…ï¼‰ï¼Œä»¥è¯¥åˆ«åçš„æ–¹æ³•åŒºæ³¨å†Œä¸­å¿ƒè·å–åˆ°å®é™…çš„æœåŠ¡é€šè®¯åœ°å€ï¼Œç„¶åå†å®ç°æœ¬åœ°RPCè°ƒç”¨ã€‚RPCè¿œç¨‹è°ƒç”¨æ¡†æ¶çš„æ ¸å¿ƒè®¾è®¡æ€æƒ³ï¼šåœ¨äºæ³¨å†Œä¸­å¿ƒï¼Œå› ä¸ºä½¿ç”¨æ³¨å†Œä¸­å¿ƒç®¡ç†æ¯ä¸ªæœåŠ¡ä¸æœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼ˆæœåŠ¡æ²»ç†ï¼‰ã€‚åœ¨ä»»ä½•RPCè¿œç¨‹æ¡†æ¶ä¸­ï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒï¼ˆå­˜æ”¾æœåŠ¡åœ°å€ç›¸å…³ä¿¡æ¯ï¼ˆæ¥å£åœ°å€ï¼‰ï¼‰

![1622018200266](.\images\1622018200266.png)

#### Eurekaä¸¤ç»„ä»¶

Eureka Server æä¾›æœåŠ¡æ³¨å†ŒåŠŸèƒ½

å„ä¸ªå¾®æœåŠ¡èŠ‚ç‚¹é€šè¿‡é…ç½®å¯åŠ¨åï¼Œä¼šåœ¨Eureka Serverä¸­è¿›è¡Œæ³¨å†Œï¼Œè¿™æ ·ï¼ŒEureka Serverä¸­çš„æœåŠ¡æ³¨å†Œè¡¨ä¸­å°†ä¼šå‚¨å­˜æ‰€æœ‰å¯ç”¨æœåŠ¡èŠ‚ç‚¹çš„ä¿¡æ¯ï¼ŒæœåŠ¡èŠ‚ç‚¹çš„ä¿¡æ¯å¯ä»¥åœ¨ç•Œé¢ä¸­ç›´è§‚çœ‹åˆ°ã€‚

Eureka Clienté€šè¿‡æ³¨å†Œä¸­å¿ƒè¿›è¡Œè®¿é—®

æ˜¯ä¸€ä¸ªJAVAå®¢æˆ·ç«¯ï¼Œç”¨äºç®€åŒ–Eureka Serverçš„äº¤äº’ï¼Œå®¢æˆ·ç«¯åŒæ—¶ä¹Ÿå…·å¤‡ä¸€ä¸ªå†…ç½®çš„ã€ä½¿ç”¨è½®è¯¢ï¼ˆround-robinï¼‰è´Ÿè½½ç®—æ³•çš„è´Ÿè½½å‡è¡¡å™¨ã€‚åœ¨åº”ç”¨å¯åŠ¨åï¼Œå°†ä¼šå‘Eureka Serverå‘é€å¿ƒè·³ï¼ˆé»˜è®¤å‘¨æœŸä¸º30ç§’ï¼‰ã€‚å¦‚æœEureka Serveråœ¨å¤šä¸ªå¿ƒè·³å‘¨æœŸå†…æ²¡æœ‰æ¥æ”¶åˆ°æŸä¸ªèŠ‚ç‚¹çš„å¿ƒè·³ï¼ŒEureka Serverå°†ä¼šä»æœåŠ¡æ³¨å†Œè¡¨ä¸­æŠŠè¿™ä¸ªæœåŠ¡èŠ‚ç‚¹ç§»é™¤ï¼ˆé»˜è®¤90ç§’ï¼‰

### å•æœºEurekaæ„å»ºæ­¥éª¤

**EurekaServerç«¯**

- æ”¹Pom.xml
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
</dependency>
```


- æ”¹appplication.yml
```yml
server:
  port: 7002
eureka:
  instance:
    hostname: eureka7002.com # eurekaæœåŠ¡ç«¯çš„å®ä¾‹åç§°
    appname: eureka-server
  client:
    # ä¸å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œè‡ªå·±
    register-with-eureka: false
    # ä¸å»æ£€ç´¢æœåŠ¡
    fetch-registry: false
    service-url:
      # è®¾ç½®ä¸EurekaServeräº¤äº’çš„åœ°å€æŸ¥è¯¢æœåŠ¡å’Œæ³¨å†ŒæœåŠ¡éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªåœ°å€
      defaultZone: http://eureka7002.com:7002/eureka/
```
- ä¸»å¯åŠ¨åŠ é…ç½®

```java
@SpringBootApplication
@EnableEurekaServer
public class EurekaMain7002 {
    public static void main(String[] args) {
        SpringApplication.run ( EurekaMain7002.class );
    }
}
```

**EurekaClient æœåŠ¡æä¾›ç«¯**

- æ”¹Pom.xml

```xml
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
```

- æ”¹appplication.yml

```yml
server:
  port: 8001

spring:
  application:
    name: cloud-payment-service
  datasource:
    # å½“å‰æ•°æ®æºæ“ä½œç±»å‹
    type: com.alibaba.druid.pool.DruidDataSource
    # mysqlé©±åŠ¨ç±»
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/2021study-springcloud?useUnicode=true&characterEncoding=UTF-8&useSSL=false&serverTimezone=GMT%2B8
    username: root
    password: root
mybatis:
  mapper-locations: classpath*:mapper/*.xml
#  type-aliases-package:

eureka:
  client:
    register-with-eureka: true
    service-url:
      defaultZone: http://eureka7002.com:7002/eureka/
    fetch-registry: true
  instance:
    instance-id: payment8001
    prefer-ip-address: true
    lease-expiration-duration-in-seconds: 1
    lease-renewal-interval-in-seconds: 2
```



- ä¸»å¯åŠ¨åŠ é…ç½®

```java
@SpringBootApplication
@EnableEurekaClient
public class PaymentMain8001 {
    public static void main(String[] args) {
        SpringApplication.run ( PaymentMain8001.class,args );
    }
}
```



> ä¹Ÿå¯ä»¥ä½¿ç”¨`@EnableDiscoveryClient`
>
> è®¿é—®http://localhost:7001æŸ¥çœ‹Eureka

### é›†ç¾¤Eurekaæ„å»ºæ­¥éª¤

**EurekaServerç«¯**

- è¦åœ¨hostsæ–‡ä»¶é‡Œæ·»åŠ 

```
127.0.0.1 eureka7001.com 
127.0.0.1 eureka7002.com 
```

- æ”¹ä¸¤ä¸ªå¾®æœåŠ¡çš„pom.xml
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
</dependency>
```


- æ”¹appplication.yml
```yml
server:
  port: 7002
eureka:
  instance:
    hostname: eureka7002.com 
    appname: eureka-server # eurekaæœåŠ¡ç«¯çš„å®ä¾‹åç§°
  client:
    # ä¸å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œè‡ªå·±
    register-with-eureka: false
    # ä¸å»æ£€ç´¢æœåŠ¡
    fetch-registry: false
    service-url:
      # è®¾ç½®ä¸EurekaServeräº¤äº’çš„åœ°å€æŸ¥è¯¢æœåŠ¡å’Œæ³¨å†ŒæœåŠ¡éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªåœ°å€
      defaultZone: http://eureka7001.com:7001/eureka/
```
- æ”¹appplication.yml

```yaml
server:
  port: 7001
eureka:
  instance:
    hostname: eureka7001.com 
    appname: eureka-server # eurekaæœåŠ¡ç«¯çš„å®ä¾‹åç§°
  client:
    # ä¸å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œè‡ªå·±
    register-with-eureka: false
    # ä¸å»æ£€ç´¢æœåŠ¡
    fetch-registry: false
    service-url:
      # è®¾ç½®ä¸EurekaServeräº¤äº’çš„åœ°å€æŸ¥è¯¢æœåŠ¡å’Œæ³¨å†ŒæœåŠ¡éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªåœ°å€
      defaultZone: http://eureka7002.com:7002/eureka/
```



- ä¸»å¯åŠ¨åŠ é…ç½®

```java
@SpringBootApplication
@EnableEurekaServer
public class EurekaMain7001 {
    public static void main(String[] args) {
        SpringApplication.run ( EurekaMain7001.class );
    }
}
```
- ä¸»å¯åŠ¨åŠ é…ç½®
```java
@SpringBootApplication
@EnableEurekaServer
public class EurekaMain7002 {
    public static void main(String[] args) {
        SpringApplication.run ( EurekaMain7002.class );
    }
}
```

**EurekaClientç«¯**

- æ”¹Pom.xml

```xml
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
</dependency>
```

- æ”¹appplication.yml

```yml
server:
  port: 8001

spring:
  application:
    name: cloud-payment-service
  datasource:
    # å½“å‰æ•°æ®æºæ“ä½œç±»å‹
    type: com.alibaba.druid.pool.DruidDataSource
    # mysqlé©±åŠ¨ç±»
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/2021study-springcloud?useUnicode=true&characterEncoding=UTF-8&useSSL=false&serverTimezone=GMT%2B8
    username: root
    password: root
mybatis:
  mapper-locations: classpath*:mapper/*.xml
#  type-aliases-package:

eureka:
  client:
    register-with-eureka: true
    service-url:
      defaultZone: http://eureka7002.com:7002/eureka/,http://eureka7001.com:7001/eureka/
    fetch-registry: true
  instance:
    instance-id: payment8001
    prefer-ip-address: true
    lease-expiration-duration-in-seconds: 1
    lease-renewal-interval-in-seconds: 2
```

- ä¸»å¯åŠ¨åŠ é…ç½®

```java
@SpringBootApplication
@EnableEurekaClient
public class PaymentMain8001 {
    public static void main(String[] args) {
        SpringApplication.run ( PaymentMain8001.class,args );
    }
}
```

> è§£å†³RestTemplateæ ¹æ®æœåŠ¡åè°ƒç”¨

```java
@Configuration
public class ApplicationContextConfig {
    @Bean
   	@LoadBalanced
    public RestTemplate getTemplate(){
        return new RestTemplate ();
    }
}
```

### Actuatorå¾®æœåŠ¡ä¿¡æ¯å®Œå–„

> - å»æ‰å¾®æœåŠ¡åç§°ä¸­çš„ä¸»æœºå
> - æ˜¾ç¤ºå¾®æœåŠ¡çš„ipåœ°å€
>
> > è¦é›†æˆActuatorï¼Œä½¿ç”¨healthå’Œinfoè¿›è¡Œå¥åº·æ£€æŸ¥
> >
> > Actuator 2.x ä¸­çš„é»˜è®¤ç«¯ç‚¹å¢åŠ äº†`/actuator`å‰ç¼€ã€‚é»˜è®¤æš´éœ²çš„ä¸¤ä¸ªç«¯ç‚¹ä¸º`/actuator/health`å’Œ `/actuator/info`

- å¼•å…¥pomä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

- æ·»åŠ é…ç½®

```yml
eureka:
	instance:
		instance-id: payment8002 # å»æ‰å¾®æœåŠ¡åç§°ä¸­çš„ä¸»æœºå
    prefer-ip-address: true # æ˜¾ç¤ºå¾®æœåŠ¡çš„ipåœ°å€
```

### æœåŠ¡å‘ç°DiscoveryClient

> ä¸»å¯åŠ¨ç±»ä¸ŠåŠ `@DiscoveryClient`

```java
@Resource
private DiscoveryClient discoveryClient;

@GetMapping(value = "/payment/discovery")
public Object discovery() {
  List<String> services = discoveryClient.getServices ();
  for (String element : services) {
    log.info ( "element:" + element );
  }
  List<ServiceInstance> instances = discoveryClient.getInstances ( "CLOUD-PAYMENT-SERVICE" );
  for (ServiceInstance instance : instances) {
    log.info ( instance.getServiceId () + "\t" + instance.getHost () + "\t" + instance.getPort () + "\t" + instance.getUri () );
  }
  return this.discoveryClient;
}
```
> æ§åˆ¶å°æ‰“å°å‡ºçš„æ—¥å¿—

```log
2021-12-01 15:59:38.882  INFO [cloud-payment-service,99a120605f86f9ec,99a120605f86f9ec,true] 17076 --- [nio-8001-exec-9] com.binyu.controller.PaymentController   : element:eureka-server
2021-12-01 15:59:38.882  INFO [cloud-payment-service,99a120605f86f9ec,99a120605f86f9ec,true] 17076 --- [nio-8001-exec-9] com.binyu.controller.PaymentController   : element:cloud-payment-service
2021-12-01 15:59:38.882  INFO [cloud-payment-service,99a120605f86f9ec,99a120605f86f9ec,true] 17076 --- [nio-8001-exec-9] com.binyu.controller.PaymentController   : element:cloud-order-service
2021-12-01 15:59:38.892  INFO [cloud-payment-service,99a120605f86f9ec,99a120605f86f9ec,true] 17076 --- [nio-8001-exec-9] com.binyu.controller.PaymentController   : CLOUD-PAYMENT-SERVICE	192.168.1.9	8002	http://192.168.1.9:8002
2021-12-01 15:59:38.892  INFO [cloud-payment-service,99a120605f86f9ec,99a120605f86f9ec,true] 17076 --- [nio-8001-exec-9] com.binyu.controller.PaymentController   : CLOUD-PAYMENT-SERVICE	192.168.1.9	8001	http://192.168.1.9:8001
```

### Eurekaè‡ªæˆ‘ä¿æŠ¤

> å®å¯ä¿ç•™é”™è¯¯çš„æœåŠ¡æ³¨å†Œä¿¡æ¯ï¼Œä¹Ÿ**ä¸ç›²ç›®æ³¨é”€ä»»ä½•å¯èƒ½å¥åº·çš„æœåŠ¡å®ä¾‹**,æ»¡è¶³CAPç†è®ºçš„AP

**è‡ªå®šä¹‰è‡ªæˆ‘ä¿æŠ¤**ï¼š

eureka-serverï¼š

```yml
eureka:
  server:
     # ç¦ç”¨è‡ªæˆ‘ä¿æŠ¤
     enable-self-preservation: false
     # æ¸…ç†æ— æ•ˆèŠ‚ç‚¹çš„æ—¶é—´é—´éš”
     eviction-interval-timer-in-ms: 2000
```

eureka-client

> ç±»ä¼¼Redissionä¸­çš„çœ‹é—¨ç‹—ç»­æœŸæœºåˆ¶ï¼Œçœ‹é—¨ç‹—é»˜è®¤æ˜¯30ç§’è¶…æ—¶ï¼Œ10ç§’ç»­æœŸ

```yml
eureka:  
  instance:
    # Eurekaå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€å¿ƒè·³çš„æ—¶é—´é—´éš”ï¼Œå•ä½ä¸ºç§’ï¼ˆé»˜è®¤30ç§’ï¼‰
    lease-expiration-duration-in-seconds: 1
    # EurekaæœåŠ¡ç«¯åœ¨æ”¶åˆ°æœ€åä¸€æ¬¡å¿ƒè·³åç­‰å¾…æ—¶é—´ä¸Šçº¿ï¼Œå•ä½ä¸ºç§’ï¼ˆé»˜è®¤90ç§’ï¼‰ï¼Œè¶…æ—¶å°†å‰”é™¤æœåŠ¡
    lease-renewal-interval-in-seconds: 2
```

## 6 ZookeeperæœåŠ¡æ³¨å†Œä¸å‘ç°

> - ä¸‹è½½ä¸å®‰è£…
> - å¯åŠ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯
>   - `./zkServer.sh start`å¯åŠ¨zookeeper
>   - `./zkCli.sh`è¿æ¥zookeeper
>     -  `ls /`æŸ¥çœ‹zookeeperæ ¹è·¯å¾„
> - æœåŠ¡èŠ‚ç‚¹æ˜¯ä¸´æ—¶èŠ‚ç‚¹ï¼ˆä¸æ˜¯æŒä¹…èŠ‚ç‚¹ï¼‰ï¼Œæ»¡è¶³CAPç†è®ºä¸­çš„CPï¼ŒEurekaæ˜¯æŒä¹…èŠ‚ç‚¹

![1622175902107](.\images\1622175902107.png)

- æ”¹pom

```xml
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-zookeeper-discovery</artifactId>
</dependency>
```

- æ”¹yml

```yml
spring:
  cloud:
    zookeeper:
      connect-string: 192.168.10.128:2181
```

- ä¸»å¯åŠ¨ 

```java
@SpringBootApplication
@EnableDiscoveryClient // è¯¥æ³¨è§£ç”¨äºå‘ä½¿ç”¨consulæˆ–zookeeperä½œä¸ºæ³¨å†Œä¸­å¿ƒæ—¶æ³¨å†ŒæœåŠ¡
public class PaymentMain8004 {
    public static void main(String[] args) {
        SpringApplication.run ( PaymentMain8004.class );
    }
}
```

## 7 ConsulæœåŠ¡æ³¨å†Œä¸å‘ç°

> Consulæ˜¯ä¸€å¥—å¼€æºçš„åˆ†å¸ƒå¼æœåŠ¡å‘ç°å’Œé…ç½®ç®¡ç†ç³»ç»Ÿï¼Œç”±HashiCorpç”¨Goè¯­è¨€å¼€å‘
>
> ConsulåŠŸèƒ½ï¼š
>
> - æœåŠ¡å‘ç°ï¼šæä¾›HTTPå’ŒDNSä¸¤ç§å‘ç°æ–¹å¼
> - å¥åº·ç›‘æµ‹ï¼šæ”¯æŒå¤šç§æ–¹å¼ï¼Œhttpï¼Œtcpï¼Œdockerï¼Œshellè„šæœ¬å®šåˆ¶åŒ–
> - KVå­˜å‚¨ï¼šKey Valueçš„å­˜å‚¨æ–¹å¼
> - å¤šæ•°æ®ä¸­å¿ƒï¼šConsulæ”¯æŒå¤šæ•°æ®ä¸­å¿ƒ
> - å¯è§†åŒ–webç•Œé¢
>
> [Consulä¸‹è½½](https://www.consul.io/downloads)

```
consul agent -dev // è¿è¡Œ
```

- æ”¹pom

```xml
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-consul-discovery</artifactId>
</dependency>
```

- æ”¹yml

```yml
spring:
  cloud:
    consul:
      host: localhost
      port: 8500
      discovery:
        service-name: ${spring.application.name}
```

- ä¸»å¯åŠ¨

```java
@SpringBootApplication
@EnableDiscoveryClient// è¯¥æ³¨è§£ç”¨äºå‘ä½¿ç”¨consulæˆ–zookeeperä½œä¸ºæ³¨å†Œä¸­å¿ƒæ—¶æ³¨å†ŒæœåŠ¡
public class PaymentMain8006 {
    public static void main(String[] args) {
        SpringApplication.run ( PaymentMain8006.class );
    }
}
```



### ä¸‰ä¸ªæ³¨å†Œä¸­å¿ƒå¼‚åŒç‚¹

> Cï¼šå¼ºä¸€è‡´æ€§
>
> Aï¼šå¯ç”¨æ€§
>
> Pï¼šåˆ†åŒºå®¹é”™æ€§

![1622272950871](.\images\1622272950871.png)

![1622272975320](.\images\1622272975320.png)



## 8 Ribbonè´Ÿè½½å‡è¡¡æœåŠ¡è°ƒç”¨

> æœªæ¥å¯èƒ½è¢«LoadBlancerä»£æ›¿

### Ribbonæœ¬åœ°è´Ÿè½½å‡è¡¡å®¢æˆ·ç«¯VS NginxæœåŠ¡ç«¯è´Ÿè½½å‡è¡¡åŒºåˆ«

> Nginxæ˜¯æœåŠ¡å™¨è´Ÿè½½å‡è¡¡ï¼Œå®¢æˆ·ç«¯æ‰€æœ‰è¯·æ±‚éƒ½ä¼šäº¤ç»™Nginxï¼Œç„¶åç”±Nginxå®ç°è½¬å‘è¯·æ±‚ã€‚å³è´Ÿè½½å‡è¡¡æ˜¯ç”±æœåŠ¡ç«¯å®ç°çš„
>
> Ribbonæœ¬åœ°è´Ÿè½½å‡è¡¡ï¼Œåœ¨è°ƒç”¨ä¸ºæœåŠ¡æ¥å£æ—¶å€™ï¼Œä¼šåœ¨æ³¨å†Œä¸­å¿ƒä¸Šè·å–æ³¨å†Œä¿¡æ¯æœåŠ¡åˆ—è¡¨ä¹‹åç¼“å­˜åˆ°JVMæœ¬åœ°ï¼Œä»è€Œåœ¨æœ¬åœ°å®ç°RPCè¿œç¨‹æœåŠ¡è°ƒç”¨æŠ€æœ¯
>

> å¼•å…¥spring-cloud-starter-netflix-eureka-clientå°±å¼•å…¥äº†spring-cloud-starter-netflix-ribbon

### IRule

![1622274895190](.\images\1622274895190.png)

7ç§è´Ÿè½½å‡è¡¡ç®—æ³•ï¼š

![1622274919714](.\images\1622274919714.png)

> Ribboné…ç½®è¦åœ¨`@SpringBootApplication`æ‰«æåŒ…ä¹‹å¤–,å¦èµ·ä¸€ä¸ªåŒ…

```java
@RibbonClient(name = "CLOUD-PAYMENT-SERVICE",configuration = MySelfRule.class)
public class OrderMain80 {
```



### æ‰‹å†™ä¸€ä¸ªè½®è¯¢è´Ÿè½½å‡è¡¡ç®—æ³•

```java
public interface LoadBalancer {
    ServiceInstance instances(List<ServiceInstance> serviceInstances);
}
```

```java
package com.binyu.lb;

import org.springframework.cloud.client.ServiceInstance;
import org.springframework.cloud.client.loadbalancer.LoadBalanced;
import org.springframework.stereotype.Component;

import java.util.List;
import java.util.concurrent.atomic.AtomicInteger;

/**
 * @BelongsProject: 2021Study-SpringCloud
 * @BelongsPackage: com.binyu.lb
 * @Author: Dong Binyu
 * @CreateTime: 2021-05-29 16:20
 * @Description:
 */
@Component
public class MyLB implements LoadBalancer {
    private AtomicInteger atomicInteger=new AtomicInteger ( 0 );
    public final int getAndIncrement(){
        int current;
        int next;
        do{
            current=this.atomicInteger.get ();
            next=current>=Integer.MAX_VALUE?0:(current+1);
        }while(!this.atomicInteger.compareAndSet ( current,next ));
        System.out.println ("----ç¬¬å‡ æ¬¡è®¿é—®ï¼Œæ¬¡æ•°next:"+next);
        return next;

    }
    @Override
    public ServiceInstance instances(List<ServiceInstance> serviceInstances) {
        int index=getAndIncrement ()%serviceInstances.size ();
        return serviceInstances.get ( index );
    }

}

```

```java
@GetMapping("/consumer/payment/lb")
public String getPaymentLB() {
  List<ServiceInstance> instances = discoveryClient.getInstances ( "CLOUD-PAYMENT-SERVICE" );
  if(instances==null||instances.size ()<0){
    return null;
  }
  ServiceInstance serviceInstance=loadBalancer.instances ( instances );
  URI uri = serviceInstance.getUri ();
  return template.getForObject ( uri+"/payment/lb",String.class );
}
```

## 9 OpenFeignè¿œç¨‹è¿‡ç¨‹è°ƒç”¨

Feignå’ŒHttpClient / OkHttpé›†æˆï¼šæé«˜APIè°ƒç”¨æ•ˆç‡çš„æœ€ä½³å®è·µï¼šhttps://ryanchan.top/archives/springboot-feign-okhttp-httpclient-best-practices

> Feignå¯ä»¥å’ŒEurekaå’ŒRibbonç»„åˆä½¿ç”¨ä»¥æ”¯æŒè´Ÿè½½å‡è¡¡

### OpenFeignçš„ä½¿ç”¨

cloud-consumer-feign-order80æ¶ˆè´¹ç«¯

```java
@Component
@FeignClient("cloud-payment-service")
public interface PaymentFeignService {
    @GetMapping("/payment/get/{id}")
    public CommonResult<Payment> getPaymentById(@PathVariable("id")Long id);
    @GetMapping("/payment/feign/timeout")
    public String paymentFeignTimeout();

}
```

```java
@SpringBootApplication
@EnableFeignClients
public class OrderFeignMain80 {
    public static void main(String[] args) {
        SpringApplication.run ( OrderFeignMain80.class );
    }
}
```

```java
@RestController
@Slf4j
public class OrderFeignController {
    @Resource
    private PaymentFeignService paymentFeignService;   
    @GetMapping("/consumer/payment/feign/timeout")
    public String paymentFeignTimeout() {
        return paymentFeignService.paymentFeignTimeout ();
    }
}
```



### OpenFeignè¶…æ—¶æ§åˆ¶

OpenFeigné»˜è®¤ç­‰å¾…1ç§’é’Ÿï¼Œå¦‚æœæœåŠ¡ç«¯å¤„ç†éœ€è¦è¶…è¿‡1ç§’é’Ÿï¼Œå¯¼è‡´æŠ¥é”™

```yml

# è®¾ç½®Feignå®¢æˆ·ç«¯è¶…æ—¶æ—¶é—´ï¼ˆOpenFeigné»˜è®¤æ”¯æŒRibbonï¼‰
    ribbon:
      # æŒ‡å®šæ˜¯å»ºç«‹è¿æ¥æ‰€ç”¨çš„æ—¶é—´ï¼Œä½¿ç”¨äºç½‘ç»œçŠ¶å†µæ­£å¸¸çš„æƒ…å†µä¸‹ï¼Œä¸¤ç«¯è¿æ¥æ‰€ç”¨çš„æ—¶é—´
      ReadTimeout: 5000
      # æŒ‡çš„æ˜¯å»ºç«‹è¿æ¥åä»æœåŠ¡å™¨è¯»å–åˆ°å¯ç”¨èµ„æºæ‰€ç”¨çš„æ—¶é—´
      ConnectTimeout: 5000
```

### OpenFeignæ—¥å¿—æ‰“å°åŠŸèƒ½

å¯¹Feignæ¥å£çš„è°ƒç”¨æƒ…å†µè¿›è¡Œç›‘æ§å’Œè¾“å‡º

```java
public enum Level {
  //é»˜è®¤ï¼Œä¸æ˜¾ç¤ºä»»ä½•æ—¥å¿—
  NONE,
  //ä»…è®°å½•è¯·æ±‚æ–¹æ³•ã€urlã€å“åº”çŠ¶æ€ç åŠæ‰§è¡Œæ—¶é—´
  BASIC,
  //é™¤è®°å½•BASICä¿¡æ¯å¤–ï¼Œè¿˜è®°å½•è¯·æ±‚å¤´å’Œå“åº”å¤´
  HEADERS,
  // é™¤äº†HEADERSä¿¡æ¯å¤–ï¼Œè¿˜æœ‰è¯·æ±‚å’Œå“åº”æ­£æ–‡ä»¥åŠå…ƒæ•°æ®
  FULL
}
```



```yml
logging:
  level:
  #feignæ—¥å¿—ä»¥ä»€ä¹ˆçº§åˆ«ç›‘æ§å“ªä¸ªæ¥å£
    com.binyu.service.PaymentFeignService: debug
```

```java
@Configuration
public class FeignConfig {
    @Bean
    Logger.Level feignLoggerLevel(){
        return Logger.Level.FULL;
    }
}
```

## 10 Hystrixæ–­è·¯å™¨

### æ¦‚è¿°

#### åˆ†å¸ƒå¼ç³»ç»Ÿé¢ä¸´çš„é—®é¢˜

**æœåŠ¡é›ªå´©**ï¼šå¤šä¸ªå¾®æœåŠ¡ä¹‹é—´è°ƒç”¨çš„æ—¶å€™ï¼Œå‡è®¾å¾®æœåŠ¡Aè°ƒç”¨å¾®æœåŠ¡Bå’Œå¾®æœåŠ¡Cï¼Œå¾®æœåŠ¡Bå’Œå¾®æœåŠ¡Cåˆè°ƒç”¨å…¶ä»–çš„å¾®æœåŠ¡ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„â€œæ‰‡å‡ºâ€ã€‚å¦‚æœæ‰‡å‡ºçš„é“¾è·¯ä¸ŠæŸä¸ªå¾®æœåŠ¡è°ƒç”¨å“åº”æ—¶é—´è¿‡é•¿æˆ–è€…ä¸å¯ç”¨ï¼Œå¯¹å¾®æœåŠ¡A çš„è°ƒç”¨å°±ä¼šå ç”¨è¶Šæ¥è¶Šå¤šçš„ç³»ç»Ÿèµ„æºï¼Œè¿›è€Œå¼•èµ·ç³»ç»Ÿå´©æºƒï¼Œæ‰€è°“çš„é›ªå´©æ•ˆåº”ã€‚

å•ä¸€çš„åç«¯ä¾èµ–å¯èƒ½ä¼šå¯¼è‡´æ‰€æœ‰æœåŠ¡å™¨ä¸Šæ‰€æœ‰èµ„æºåœ¨å‡ ç§’é’Ÿå†…é¥±å’Œã€‚æ¯”å¤±è´¥æ›´ç³Ÿç³•çš„æ˜¯ï¼Œè¿™äº›åº”ç”¨ç¨‹åºè¿˜å¯èƒ½å¯¼è‡´æœåŠ¡ä¹‹é—´çš„å»¶è¿Ÿå¢åŠ ï¼Œå¤‡ä»½é˜Ÿåˆ—ï¼Œçº¿ç¨‹å’Œå…¶ä»–çš„èµ„æºç´§å¼ ï¼Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå‘ç”Ÿæ›´å¤šçš„çº§è”æ•…éšœã€‚

è¿™äº›éƒ½è¡¨ç¤ºéœ€è¦å¯¹æ•…éšœå’Œå»¶è¿Ÿè¿›è¡Œéš”ç¦»å’Œç®¡ç†ï¼Œä»¥ä¾¿å•ä¸ªä¾èµ–å…³ç³»çš„å¤±è´¥ï¼Œä¸èƒ½å–æ¶ˆæ•´ä¸ªåº”ç”¨ç¨‹åºæˆ–ç³»ç»Ÿ

#### Hystrixæ˜¯ä»€ä¹ˆ

Hystrixæ˜¯ä¸€ä¸ªç”¨äºå¤„ç†åˆ†å¸ƒå¼ç³»ç»Ÿçš„å»¶è¿Ÿå’Œå®¹é”™çš„å¼€æºåº“ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿé‡Œï¼Œè®¸å¤šä¾èµ–ä¸å¯é¿å…çš„ä¼šè°ƒç”¨å¤±è´¥ï¼Œæ¯”å¦‚è¶…æ—¶ã€å¼‚å¸¸ç­‰ï¼ŒHytrixèƒ½å¤Ÿä¿è¯åœ¨ä¸€ä¸ªä¾èµ–å‡ºé—®é¢˜çš„æƒ…å†µ ä¸‹ï¼Œä¸ä¼šå¯¼è‡´æ•´ä¸ªæœåŠ¡å¤±è´¥ï¼Œé¿å…çº§è”æ•…éšœï¼Œä»¥æé«˜åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¼¹æ€§ã€‚

â€œæ–­è·¯å™¨â€æœ¬èº«æ˜¯ä¸€ç§å¼€å…³è£…ç½®ï¼Œå½“æŸä¸ªæœåŠ¡å•å…ƒå‘ç”Ÿæ•…éšœä¹‹åï¼Œé€šè¿‡æ–­è·¯å™¨çš„ç›‘æ§æ•…éšœï¼ˆç±»ä¼¼ç†”æ–­ä¿é™©ä¸ï¼‰ï¼Œè¿™æ ·å°±ä¿è¯äº†æœåŠ¡è°ƒç”¨æ–¹çš„çº¿ç¨‹ä¸ä¼šè¢«é•¿æ—¶é—´ä¸å¿…è¦åœ°å ç”¨ï¼Œä»è€Œé¿å…äº†æ•…éšœåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„è”“å»¶ï¼Œä¹ƒè‡³é›ªå´©ã€‚

#### Hystrixçš„åŠŸèƒ½

æœåŠ¡é™çº§ï¼ŒæœåŠ¡ç†”æ–­ï¼Œæ¥è¿‘å®æ—¶çš„ç›‘æ§ï¼Œé™æµï¼Œéš”ç¦»

### Hystrixé‡è¦æ¦‚å¿µ

æœåŠ¡é™çº§fallbackï¼šæœåŠ¡å™¨å¿™ï¼Œè¯·ç¨åå†è¯•ï¼Œä¸è®©å®¢æˆ·ç«¯ç­‰å¾…å¹¶ç«‹å³è¿”å›ä¸€ä¸ªå‹å¥½æç¤ºï¼ŒFallbackã€‚

â€‹						å“ªäº›æƒ…å†µä¼šå‘å‡ºé™çº§ï¼šç¨‹åºè¿è¡Œå¼‚å¸¸ï¼Œè¶…æ—¶ï¼ŒæœåŠ¡ç†”æ–­è§¦å‘æœåŠ¡é™çº§ï¼Œçº¿åŸæ± /ä¿¡å·é‡æ‰“æ»¡

æœåŠ¡ç†”æ–­breakï¼šç±»æ¯”ä¿é™©ä¸è¾¾åˆ°æœ€å¤§æœåŠ¡è®¿é—®åï¼Œç›´æ¥æ‹’ç»è®¿é—®ï¼Œæ‹‰é—¸é™ç”µ

â€‹					å°±æ˜¯ä¿é™©ä¸ï¼šæœåŠ¡çš„é™çº§->è¿›è€Œç†”æ–­->æ¢å¤è°ƒç”¨é“¾è·¯

æœåŠ¡é™æµflowlimit:ç§’æ€é«˜å¹¶å‘æ“ä½œï¼Œä¸¥ç¦æ‹¥æŒ¤ï¼Œæ’é˜Ÿæœ‰åº

### Hystrixæ¡ˆä¾‹

[Jmeterå‹åŠ›æµ‹è¯•](https://www.cnblogs.com/monjeo/p/9330464.html)

å¼€å¯Jmeterï¼Œæ¥20000ä¸ªå¹¶å‘å‹æ­»8001ï¼Œ20000ä¸ªè¯·æ±‚éƒ½å»è®¿é—®paymentInfo_Timeout

ç»“æœè®¿é—®http://localhost:8001/payment/hystrix/ok/31å’Œhttp://localhost:8001/payment/hystrix/timeout/31éƒ½ä¼šè½¬åœˆåœˆã€‚å› ä¸ºtomcatçš„é»˜è®¤å·¥ä½œçº¿ç¨‹æ•°è¢«æ‰“æ»¡äº†ï¼Œæ²¡æœ‰å¤šä½™çš„çº¿ç¨‹æ¥åˆ†è§£å‹åŠ›å’Œå¤„ç†

å¦‚ä½•è§£å†³ï¼Ÿ

- è¶…æ—¶ä¸å†ç­‰å¾…
- å‡ºé”™è¦æœ‰å…œåº•

```java
@HystrixCommand(fallbackMethod = "paymentInfo_TimeoutHandler",commandProperties = {@HystrixProperty ( name="execution.isolation.thread.timeoutInMilliseconds",value = "3000"
    )})
    public String paymentInfo_Timeout(Integer id){
        try{
            TimeUnit.SECONDS.sleep ( 3 );
        } catch (InterruptedException e) {
            e.printStackTrace ();
        }
        return "çº¿åŸæ± "+Thread.currentThread ().getName ()+"paymentInfo_OK,id"+id+"è€—æ—¶3ç§’";
    }
    public String paymentInfo_TimeoutHandler(Integer id){
        return "çº¿åŸæ± "+Thread.currentThread ().getName ()+"paymentInfo_TimeoutHandler,id"+id+"å“­å“­";
    }
```

```java
@SpringBootApplication
@EnableEurekaClient
@EnableCircuitBreaker
public class PaymentHystrix8001 {
    public static void main(String[] args) {
        SpringApplication.run ( PaymentHystrix8001.class );
    }
}
```

```java
@GetMapping("/consumer/payment/hystrix/timeout/{id}")
    @HystrixCommand(fallbackMethod = "paymentTimeoutFallbackMethod",commandProperties = {@HystrixProperty ( name = "execution.isolation.thread.timeoutInMilliseconds",value = "1500")})
    public String paymentInfo_Timeout(@PathVariable("id") Integer id){
        return paymentHystrixService.paymentInfo_Timeout ( id );
    }
    public String paymentTimeoutFallbackMethod(@PathVariable("id") Integer id){
        return "æˆ‘æ˜¯æ¶ˆè´¹è€…80ï¼Œå¯¹æ–¹æ”¯ä»˜ç³»ç»Ÿç¹å¿™o(â•¥ï¹â•¥)o";
    }
```

```java
@SpringBootApplication
@EnableFeignClients
@EnableHystrix
public class OrderHystrixMain80 {
    public static void main(String[] args) {
        SpringApplication.run ( OrderHystrixMain80.class );
    }
}
```

```yml
feign:
  hystrix:
    enabled: true
```

----



>@EnableHystrixä¸@EnableCircuitBreakerçš„åŒºåˆ«:
>@EnableCircuitBreaker // å¼€å¯ç†”æ–­å™¨
>@EnableHystrix //å¼€å¯ Hystrix
>@EnableHystrixç»§æ‰¿äº†@EnableCricuitBreaker

```java
// å…¨å±€å…œåº•æ–¹æ³•
@DefaultProperties(defaultFallback = "paymentTimeoutFallbackMethod")
public class OrderHystrixController {
```

```java
// å¯ç”¨å…¨å±€å…œåº•æ–¹æ³•
@HystrixCommand
```

----

è§£å†³æœåŠ¡é™çº§ fallbackæ–¹æ³•è€¦åˆé«˜çš„é—®é¢˜

```java
@Component
public class PaymentFallbackService implements PaymentHystrixService {
    @Override
    public String paymentInfo_OK(Integer id) {
        return "fallback paymentInfo_OK o(â•¥ï¹â•¥)o";
    }

    @Override
    public String paymentInfo_Timeout(Integer id) {
        return "fallback paymentInfo_Timeout o(â•¥ï¹â•¥)o";
    }
}

```

```java
@Component
@FeignClient(value = "CLOUD-PROVIDER-HYSTRIX-PAYMENT" ,fallback = PaymentFallbackService.class)
public interface PaymentHystrixService {
```

----

[CSDN-Hystrix ç”¨æ³•,@HystrixPropertyå‚æ•°è¯´æ˜](https://blog.csdn.net/weixin_45498999/article/details/108982100)

æœåŠ¡é™çº§->ç†”æ–­å->ä¼šå°è¯•åŠå¼€ï¼Œå¦‚æœå¯ä»¥å°±æ¢å¤é“¾è·¯

```java
// æœåŠ¡ç†”æ–­
    @HystrixCommand(fallbackMethod = "paymentCircuitBreaker_fallback",commandProperties = {
            @HystrixProperty (name = "circuitBreaker.enabled",value = "true"),// æ˜¯å¦å¼€å¯æ–­è·¯å™¨
            @HystrixProperty (name = "circuitBreaker.requestVolumeThreshold",value = "10"),// è¯·æ±‚æ¬¡æ•°
            @HystrixProperty (name = "circuitBreaker.sleepWindowInMilliseconds",value = "10000"),// æ—¶é—´çª—å£æœŸï¼Œç»Ÿè®¡æ—¶é—´èŒƒå›´å°±æ˜¯å¿«ç…§æ—¶é—´çª—
            @HystrixProperty ( name = "circuitBreaker.errorThresholdPercentage",value = "60")// å¤±è´¥ç‡è¾¾åˆ°å¤šå°‘åè·³é—¸
    })
    public String paymentCircuitBreaker(@PathVariable("id")Integer id){
        if(id<0){
            throw new RuntimeException ( "idä¸èƒ½ä¸ºè´Ÿæ•°" );
        }
        String servialNumber= IdUtil.simpleUUID ();
        return Thread.currentThread ().getName ()+"\t"+"è°ƒç”¨æˆåŠŸï¼Œæµæ°´å·ï¼š"+servialNumber;
    }
    public String paymentCircuitBreaker_fallback(@PathVariable("id")Integer id){
        return "idä¸èƒ½ä¸ºè´Ÿæ•°ï¼Œè¯·ç¨åå†è¯•,id:"+id;
    }
```

### Hystrix Dashboard

Hystrix Dashboardç›‘æ§çš„ä¸»å¯åŠ¨ç±»ï¼š

```JAVA
@SpringBootApplication
@EnableHystrixDashboard
public class HystrixDashboardMain9001 {
    public static void main(String[] args) {
        SpringApplication.run ( HystrixDashboardMain9001.class );
    }
}
```

è¢«ç›‘æ§çš„æœåŠ¡ä¸»å¯åŠ¨ç±»ï¼š

```java
@SpringBootApplication
@EnableEurekaClient
@EnableCircuitBreaker
public class PaymentHystrixMain8001 {
    public static void main(String[] args) {
        SpringApplication.run ( PaymentHystrixMain8001.class );
    }

    /**
     * æ­¤é…ç½®æ˜¯ä¸ºæœåŠ¡ç›‘æ§è€Œé…ç½®ï¼Œä¸æœåŠ¡å®¹é”™æœ¬èº«æ— å…³
     * @return
     */
    @Bean
    public ServletRegistrationBean getServlet(){
        HystrixMetricsStreamServlet hystrixMetricsStreamServlet = new HystrixMetricsStreamServlet ();
        ServletRegistrationBean servletRegistrationBean = new ServletRegistrationBean ( hystrixMetricsStreamServlet );
        servletRegistrationBean.setLoadOnStartup ( 1 );
        servletRegistrationBean.addUrlMappings ( "/hystrix.stream" );
        servletRegistrationBean.setName ( "HystrixMetricsStreamServlet" );
        return servletRegistrationBean;
    }
}
```

è®¿é—®http://localhost9001/hystrixç›‘æ§http://localhost:8001/hystrix.stream

![1622541717771](.\images\1622541717771.png)

![1622541728953](.\images\1622541728953.png)

## 12 Gatewayè·¯ç”±ç½‘å…³

[Spring Cloud Gateway Corsè·¨åŸŸé—®é¢˜çš„è§£å†³](https://www.cnblogs.com/duniqb/p/12702542.html)

https://segmentfault.com/a/1190000045200059

- **GlobalFilter**ï¼šé€‚ç”¨äºå…¨å±€æ€§çš„æ“ä½œï¼Œæ˜“äºå®ç°ä½†ç¼ºä¹ç»†ç²’åº¦æ§åˆ¶ã€‚
- **GatewayFilter**ï¼šæä¾›ç»†ç²’åº¦æ§åˆ¶ï¼Œå¯ä»¥é’ˆå¯¹ç‰¹å®šè·¯ç”±åº”ç”¨ï¼Œé€šè¿‡ `@Component` æ³¨è§£è‡ªåŠ¨æ‰«æã€‚
- **AbstractGatewayFilterFactory**ï¼šæä¾›æ›´é«˜çº§åˆ«çš„å®šåˆ¶æ€§å’Œçµæ´»æ€§ï¼Œé€‚ç”¨äºå¤æ‚çš„åœºæ™¯ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ YAML æ–‡ä»¶æ¥é…ç½®ï¼ŒåŒæ ·é€šè¿‡ `@Component` æ³¨è§£è‡ªåŠ¨æ‰«æ

> ä»€ä¹ˆæ˜¯websocketï¼Œä»€ä¹ˆæ˜¯nettyï¼Œä»€ä¹ˆæ˜¯éé˜»å¡IOï¼Ÿ

| é˜¶æ®µ                  | ç»„ä»¶                               | åŠŸèƒ½                                                         |
| --------------------- | ---------------------------------- | ------------------------------------------------------------ |
| **1. å®¢æˆ·ç«¯è¯·æ±‚**     | æµè§ˆå™¨/APP                         | å‘èµ·è¯·æ±‚ï¼Œæºå¸¦ Tokenï¼ˆå¦‚ JWTï¼‰                               |
| **2. ç½‘å…³å±‚**         | `GlobalFilter`                     | - ç™»å½•æ ¡éªŒ - å°†ç”¨æˆ·ä¿¡æ¯æå–å¹¶æ”¾å…¥è¯·æ±‚å¤´ï¼ˆå¦‚ `X-User-ID`ï¼‰ - è½¬å‘è¯·æ±‚åˆ°ä¸‹æ¸¸å¾®æœåŠ¡ |
| **3. å¾®æœåŠ¡ A**       | `HandlerInterceptor`               | - ä»è¯·æ±‚å¤´è·å–ç”¨æˆ·ä¿¡æ¯ - å­˜å…¥ `ThreadLocal`ï¼Œä¾›ä¸šåŠ¡é€»è¾‘ä½¿ç”¨  |
| **4. è°ƒç”¨å…¶ä»–å¾®æœåŠ¡** | `OpenFeign` + `RequestInterceptor` | - åœ¨ Feign è¯·æ±‚å‰æ‹¦æˆª - å°†å½“å‰çº¿ç¨‹ä¸­çš„ç”¨æˆ·ä¿¡æ¯é‡æ–°å†™å…¥è¯·æ±‚å¤´ - ä¿è¯è°ƒç”¨é“¾ä¸­ç”¨æˆ·ä¸Šä¸‹æ–‡ä¸ä¸¢å¤± |

### æ¦‚è¿°

#### Gatewayæ˜¯ä»€ä¹ˆ

æ˜¯Zuul 1.xçš„æ›¿ä»£ã€‚è€Œä¸ºäº†æå‡ç½‘å…³çš„æ€§èƒ½ï¼ŒSpring Cloud Gateway æ˜¯åŸºäºWebFluxæ¡†æ¶å®ç°çš„ï¼Œè€ŒWebFluxæ¡†æ¶åº•å±‚åˆ™ä½¿ç”¨äº†é«˜æ€§èƒ½çš„Reactoræ¨¡å¼é€šä¿¡æ¡†æ¶Nettyã€‚

Zuul1.xæ˜¯é˜»å¡å¼Servletæ¨¡å‹ï¼ŒGatewayæ˜¯å¼‚æ­¥éé˜»å¡çš„

#### Gatewayçš„åŠŸèƒ½

åå‘ä»£ç†ã€é‰´æƒã€æµé‡æ§åˆ¶ã€ç†”æ–­ã€æ—¥å¿—ç›‘æ§ã€‚ã€‚ã€‚

 #### ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µ

**è·¯ç”±Routeï¼š**

è·¯ç”±æ˜¯æ„å»ºç½‘å…³çš„åŸºæœ¬æ¨¡å—ï¼Œå®ƒç”±IDã€ç›®æ ‡URIï¼Œä¸€ç³»åˆ—çš„æ–­è¨€å’Œè¿‡æ»¤å™¨ç»„æˆï¼Œå¦‚æœæ–­è¨€ä¸ºtrueåˆ™åŒ¹é…è¯¥è·¯ç”±

**Predicateæ–­è¨€ï¼š**

å‚è€ƒJAVA8çš„Predicateï¼Œå¼€å‘äººå‘˜å¯ä»¥åŒ¹é…HTTPè¯·æ±‚ä¸­æ‰€æœ‰å†…å®¹ï¼ˆä¾‹å¦‚è¯·æ±‚å¤´å’Œè¯·æ±‚å‚æ•°ï¼‰ï¼Œå¦‚æœè¯·æ±‚ä¸æ–­è¨€ç›¸åŒ¹é…åˆ™è¿›è¡Œè·¯ç”±

**Filterè¿‡æ»¤å™¨ï¼š**

æŒ‡Springæ¡†æ¶ä¸­GatewayFilterçš„å®ä¾‹ï¼Œä½¿ç”¨è¿‡æ»¤å™¨å¯ä»¥åœ¨è¯·æ±‚è¢«è·¯ç”±å‰æˆ–è€…åå¯¹è¯·æ±‚è¿›è¡Œä¿®æ”¹

gatewayå·¥ä½œæµç¨‹æ ¸å¿ƒé€»è¾‘ï¼š

è·¯ç”±è½¬å‘+æ‰§è¡Œè¿‡æ»¤å™¨é“¾

### Gatewayæ¡ˆä¾‹

- ymlé…ç½®æ–¹å¼ï¼š

```yml
 spring:
     cloud:
        gateway:
          routes:
            - id: payment_routh # è·¯ç”±çš„IDï¼Œæ²¡æœ‰å›ºå®šè§„åˆ™ä½†è¦æ±‚å”¯ä¸€ï¼Œå»ºè®®é…åˆæœåŠ¡å
              uri: http://localhost:8001 # åŒ¹é…åæä¾›æœåŠ¡çš„è·¯ç”±åœ°å€
              predicates:
                - Path=/payment/get/** # æ–­è¨€ï¼Œè·¯å¾„ç›¸åŒ¹é…çš„è¿›è¡Œè·¯ç”±
            - id: payment_routh2
              uri: http://localhost:8001
              predicates:
                - Path=/payment/lb/**
```

- JAVAé…ç½®ç±»ç¼–ç æ–¹å¼ï¼š

  > çœ‹åˆ°è¿™ä½ åº”è¯¥ä¼šæŸ¥æ€ä¹ˆå†™äº†

### GatewayåŠ¨æ€è·¯ç”±

```yml
 cloud:
    gateway:
      discovery:
        locator:
          enabled: true # å¼€å¯åŠ¨æ€è·¯ç”±
      routes:
        - id: payment_routh # è·¯ç”±çš„IDï¼Œæ²¡æœ‰å›ºå®šè§„åˆ™ä½†è¦æ±‚å”¯ä¸€ï¼Œå»ºè®®é…åˆæœåŠ¡å
#          uri: http://localhost:8001 # åŒ¹é…åæä¾›æœåŠ¡çš„è·¯ç”±åœ°å€
          uri: lb://cloud-payment-service
          predicates:
            - Path=/payment/get/** # æ–­è¨€ï¼Œè·¯å¾„ç›¸åŒ¹é…çš„è¿›è¡Œè·¯ç”±
        - id: payment_routh2
#          uri: http://localhost:8001
          uri: lb://cloud-payment-service
          predicates:
            - Path=/payment/lb/**
```

### Predicateçš„ä½¿ç”¨

[Springå®˜ç½‘-5. Route Predicate Factories](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories)

### Filterçš„ä½¿ç”¨

[Springå®˜ç½‘-6. `GatewayFilter` Factories](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories)

Springæä¾›çš„è¿‡æ»¤å™¨ï¼š

```yml
spring:
  cloud:
    gateway:
      routes:
      - id: add_request_header_route
        uri: https://example.org
        filters:
        - AddRequestHeader=X-Request-red, blue
```



### è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨

 ä¸»è¦æ˜¯å®ç° GlobalFilter, Ordered

```java
@Component
@Slf4j
public class MyLogGatewayFilter implements GlobalFilter, Ordered {
    // è¿‡æ»¤å™¨æ–¹æ³•
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        log.info("come in "+new Date() );
        String uname = exchange.getRequest ().getQueryParams ().getFirst ( "uname" );
        if(uname==null){
            log.info ( "ç”¨æˆ·åä¸ºNull,éæ³•ç”¨æˆ·o(â•¥ï¹â•¥)o" );
            exchange.getResponse ().setStatusCode ( HttpStatus.NOT_ACCEPTABLE );
            return exchange.getResponse ().setComplete ();
        }

        return chain.filter ( exchange );
    }
// åŠ è½½è¿‡æ»¤å™¨çš„ä¼˜å…ˆçº§
    @Override
    public int getOrder() {
        return 0;
    }
}

```

## 13 Spring Cloud ConfigæœåŠ¡é…ç½®

### æ¦‚è¿°

> é›†ä¸­ç®¡ç†é…ç½®æ–‡ä»¶ã€‚
>
> ä¸åŒç¯å¢ƒä¸åŒé…ç½®ï¼ŒåŠ¨æ€åŒ–çš„é…ç½®æ›´æ–°ï¼Œåˆ†ç¯å¢ƒéƒ¨ç½²æ¯”å¦‚dev/test/prod/beta/release
>
> ä¸éœ€è¦åœ¨æ¯ä¸ªæœåŠ¡éƒ¨ç½²çš„æœºå™¨ä¸Šç¼–å†™é…ç½®æ–‡ä»¶ï¼ŒæœåŠ¡ä¼šå‘é…ç½®ä¸­å¿ƒç»Ÿä¸€æ‹‰å–é…ç½®è‡ªå·±çš„ä¿¡æ¯
>
> å½“é…ç½®å‘ç”Ÿæ”¹å˜æ—¶ï¼ŒæœåŠ¡ä¸éœ€è¦é‡å¯å³å¯æ„ŸçŸ¥åˆ°é…ç½®çš„å˜åŒ–å¹¶åº”ç”¨æ–°çš„é…ç½®
>
> å°†é…ç½®ä¿¡æ¯ä»¥Restæ¥å£çš„å½¢å¼æš´éœ²

### ConfigæœåŠ¡ç«¯é…ç½®ä¸æµ‹è¯•

- githubå»ºç«‹springcloud-config

- æ”¹pom

```xml
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-config-server</artifactId>
</dependency>
```

- æ”¹yml

```yml
server:
  port: 3344

spring:
  application:
    name: cloud-config-center
  datasource:
    # å½“å‰æ•°æ®æºæ“ä½œç±»å‹
    type: com.alibaba.druid.pool.DruidDataSource
    # mysqlé©±åŠ¨ç±»
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/2021study-springcloud?useUnicode=true&characterEncoding=UTF-8&useSSL=false&serverTimezone=GMT%2B8
    username: root
    password: root
  cloud:
    config:
      server:
        git:
          uri: https://github.com/dby321/springcloud-config.git
          search-paths:
            - springcloud-config
          default-label: main
      label: main
eureka:
  client:
    register-with-eureka: true
    service-url:
      defaultZone: http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka
    fetch-registry: true
```

- ä¸»å¯åŠ¨ç±»

```java
@SpringBootApplication
@EnableConfigServer
public class ConfigCenterMain3344 {
    public static void main(String[] args) {
        SpringApplication.run ( ConfigCenterMain3344.class );
    }
}
```

è¯»å–é…ç½®æ–‡ä»¶:

`/{label}/{application}-{profile}.yml`ã€ç”¨è¿™ä¸ªã€‘

`/{application}-{profile}.yml`

`/{application}/{profile}/{label}.yml`

### Configå®¢æˆ·ç«¯é…ç½®ä¸æµ‹è¯•

**åˆ†å¸ƒå¼é…ç½®çš„åŠ¨æ€åˆ·æ–°é—®é¢˜**ï¼š

- linuxè¿ç»´ä¿®æ”¹Gituhbä¸Šé…ç½®æ–‡ä»¶å†…å®¹
- åˆ·æ–°3344ï¼ŒConfigServerç«‹åˆ»å“åº”
- åˆ·æ–°3355ï¼ŒConfigClientå®¢æˆ·ç«¯æ²¡æœ‰ä»»ä½•å“åº”
- **3355æ²¡æœ‰å˜åŒ–é™¤éè‡ªå·±é‡å¯æˆ–è€…é‡æ–°åŠ è½½**

```yml
spring:
  cloud:
    config:
      label: main
      name: config
      profile: dev
      uri: http://localhost:3344
```



### Configå®¢æˆ·ç«¯åŠ¨æ€åˆ·æ–°

#### æ–¹å¼ä¸€

- æ”¹yml

```yml
management:
  endpoints:
    web:
      exposure:
        include: "*"
```

- ä¸»å¯åŠ¨ç±»

```java
@RestController
@RefreshScope
public class ConfigClientController {
```

#### æ–¹å¼äºŒ

å‘é€poståˆ·æ–°3355

```cmd
curl -X POST "http://localhost:3355/actuator/refresh"
```

## 14 SpringCloud Busæ¶ˆæ¯æ€»çº¿

### æ¦‚è¿°

> Busé…åˆConfigä½¿ç”¨å¯ä»¥å®ç°é…ç½®çš„åŠ¨æ€åˆ·æ–°
>
> Busæ”¯æŒä¸¤ç§æ¶ˆæ¯ä»£ç†ï¼šRabbitMQå’ŒKafka 
>
> SpringCloud Busæ˜¯ç”¨æ¥å°†åˆ†å¸ƒå¼ç³»ç»Ÿçš„èŠ‚ç‚¹ä¸è½»é‡çº§æ¶ˆæ¯ç³»ç»Ÿé“¾æ¥èµ·æ¥çš„æ¡†æ¶ï¼Œå®ƒæ•´åˆäº†Javaçš„äº‹ä»¶å¤„ç†æœºåˆ¶å’Œæ¶ˆæ¯ä¸­é—´ä»¶åŠŸèƒ½
>
> åœ¨å¾®æœåŠ¡æ¶æ„çš„ç³»ç»Ÿä¸­ï¼Œé€šå¸¸ä¼šä½¿ç”¨è½»é‡çº§çš„æ¶ˆæ¯ä»£ç†æ¥æ„å»ºä¸€ä¸ªå…±ç”¨çš„æ¶ˆæ¯ä¸»é¢˜ï¼Œå¹¶è®©ç³»ç»Ÿä¸­æ‰€æœ‰çš„å¾®æœåŠ¡å®ä¾‹éƒ½è¿æ¥ä¸Šæ¥ã€‚ç”±äºè¯¥ä¸»é¢˜ä¸­äº§ç”Ÿçš„æ¶ˆæ¯ä¼šè¢«æ‰€æœ‰å®ä¾‹ç›‘å¬å’Œæ¶ˆè´¹ï¼Œæ‰€ä»¥ç§°å®ƒä¸ºæ¶ˆæ¯æ€»çº¿ã€‚åœ¨æ€»çº¿ä¸Šçš„å„ä¸ªå®ä¾‹ï¼Œéƒ½å¯ä»¥æ–¹ä¾¿åœ°å¹¿æ’­ä¸€äº›éœ€è¦è®©å…¶ä»–è¿æ¥åœ¨è¯¥ä¸»é¢˜ä¸Šçš„å®ä¾‹éƒ½çŸ¥é“çš„æ¶ˆæ¯
>
> ConfigClientå®ä¾‹éƒ½ç›‘å¬MQä¸­åŒä¸€ä¸ªtopicï¼ˆé»˜è®¤æ˜¯SpringCloudBusï¼‰ã€‚å½“ä¸€ä¸ªæœåŠ¡åˆ·æ–°æ•°æ®çš„æ—¶å€™ï¼Œå®ƒä¼šæŠŠè¿™ä¸ªæ¶ˆæ¯æ”¾å…¥topicä¸­ï¼Œè¿™æ ·å…¶ä»–ç›‘å¬åŒä¸€topicçš„æœåŠ¡å°±èƒ½å¾—åˆ°é€šçŸ¥ï¼Œç„¶åå»æ›´æ–°è‡ªèº«çš„é…ç½®ã€‚
>
> > ç±»ä¼¼å‰ç«¯vueæœ‰æ€»çº¿å’Œpubsubï¼Œåç«¯ä¹Ÿæœ‰æ€»çº¿å’ŒMQ

### RabbitMQç¯å¢ƒé…ç½®

> å®‰è£…ERlangï¼Œå®‰è£…RabbitMQ

```
D:\RabbitMQ\rabbitmq_server-3.8.16\sbin>rabbitmq-plugins.bat enable rabbitmq_management
```

ä½¿ç”¨startå¯åŠ¨RabbitMQï¼Œç„¶åè®¿é—®http://localhost:15672ï¼Œè´¦å·å¯†ç guestç™»å½•

> å¦‚æœRabbitMQå¯åŠ¨æ—¶ç«¯å£è¢«å ç”¨ï¼Œéœ€è¦åˆ©ç”¨ `netstat -ano `æŸ¥çœ‹è¿›ç¨‹ç«¯å£å·ï¼Œå¹¶é…Œæƒ…ç»“æŸè¿›ç¨‹

###  SpringCloud BusåŠ¨æ€åˆ·æ–°å…¨å±€å¹¿æ’­

cloud-config-center3344ä¿®æ”¹

- æ”¹pom

```xml
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-bus-amqp</artifactId>
</dependency>
```

- æ”¹yml

```yml
spring:
  cloud:
    config:
      server:
        git:
          uri: https://github.com/dby321/springcloud-config.git
          search-paths:
            - springcloud-config
          default-label: main
      label: main
  rabbitmq:
    host: localhost
    port: 5672
    username: guest
    password: guest

management:
  endpoints: # æš´éœ²busåˆ·æ–°é…ç½®çš„ç«¯ç‚¹,å›ºå®šå†™æ³•
    web:
      exposure:
        include: "bus-refresh"
```

[ no queue 'springCloudBus.anonymous.6Xa99MDZTJyHKdPqMyoVEA' BUGè§£å†³](https://www.cnblogs.com/gqymy/p/11257861.html)

è¿ç»´ä¸€æ¬¡å‘é€ï¼Œå¤„å¤„ç”Ÿæ•ˆ

```cmd
curl -X POST http://localhost:3344/actuator/bus-refresh
```

### SpringCloud BusåŠ¨æ€åˆ·æ–°å®šç‚¹é€šçŸ¥

> åªæ›´æ–°äº†3355ï¼Œæ²¡æœ‰æ›´æ–°3366

```cmd
curl -X POST http://localhost:3344/actuator/bus-refresh/{destination}
curl -X POST http://localhost:3344/actuator/bus-refresh/config-client:3355
```

## 15 SpringCloud Streamæ¶ˆæ¯é©±åŠ¨

### æ¦‚è¿°

å±è”½åº•å±‚æ¶ˆæ¯ä¸­é—´ä»¶çš„å·®å¼‚ï¼Œé™ä½åˆ‡æ¢æˆæœ¬ï¼Œç»Ÿä¸€æ¶ˆæ¯çš„ç¼–ç¨‹æ¨¡å‹

Streamæ¶ˆæ¯é€šä¿¡æ–¹å¼æ˜¯å‘å¸ƒ-è®¢é˜…æ¨¡å¼


Binderï¼šå¾ˆæ–¹ä¾¿çš„è¿æ¥ä¸­é—´ä»¶ï¼Œå±è”½å·®å¼‚

Channelï¼šé€šé“ï¼Œæ˜¯é˜Ÿåˆ—Queueçš„ä¸€ç§æŠ½è±¡ï¼Œåœ¨æ¶ˆæ¯é€šè®¯ç³»ç»Ÿä¸­å°±æ˜¯å®ç°äº†å­˜å‚¨å’Œè½¬å‘çš„åª’ä»‹ï¼Œé€šè¿‡Channelå¯¹é˜Ÿåˆ—è¿›è¡Œé…ç½®

Sourceå’ŒSinkï¼šæ¶ˆæ¯çš„è¾“å…¥è¾“å‡º

### æ¡ˆä¾‹è¯´æ˜

æ–°å»ºcloud-stream-rabbitmq-provider8801ã€cloud-stream-rabbitmq-consumer8803ã€cloud-stream-rabbitmq-consumer8802

### æ¶ˆæ¯é©±åŠ¨ä¹‹ç”Ÿäº§è€…

- æ”¹pom

```xml
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-stream-rabbit</artifactId>
</dependency>
```

- æ”¹yml

```yml
spring:
  cloud:
    stream:
      binders: # åœ¨æ­¤å¤„é…ç½®è¦ç»‘å®šçš„RabbitMQçš„æœåŠ¡ä¿¡æ¯
        defaultRabbit: # è¡¨ç¤ºå®šä¹‰çš„åç§°ï¼Œç”¨äºbindingæ•´åˆ
          type: rabbit # æ¶ˆæ¯ç»„ä»¶ç±»å‹
          environment: # è®¾ç½®rabbitmqç›¸å…³ç¯å¢ƒé…ç½®
            spring:
              rabbitmq:
                host: localhost
                port: 5672
                username: guest
                password: guest
      bindings: # æœåŠ¡çš„æ•´åˆå¤„ç†
        output: # è¿™ä¸ªåå­—æ˜¯ä¸€ä¸ªé€šé“çš„åç§°
          destination: studyExchange # è¡¨ç¤ºè¦ä½¿ç”¨çš„Exchangeåç§°å®šä¹‰
          content-type: application/json # è®¾ç½®æ¶ˆæ¯ç±»å‹ï¼Œæœ¬æ¬¡ä¸ºjson,æ–‡æœ¬åˆ™è®¾ç½®â€œtext/jsonâ€
          binder: {defaultRabbit} # è®¾ç½®è¦ç»‘å®šçš„æ¶ˆæ¯æœåŠ¡çš„å…·ä½“è®¾ç½®
          group: consumerA
```

- å®šä¹‰ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ï¼ŒSource.classæ˜¯streamæä¾›çš„

```java
@EnableBinding(Source.class)// å®šä¹‰æ¶ˆæ¯çš„æ¨é€ç®¡é“
public class MessageProviderImpl implements IMessageProvider {

    @Resource
    private MessageChannel output;
    @Override
    public String send() {
        String serial= UUID.randomUUID ().toString ();
        output.send ( MessageBuilder.withPayload ( serial ).build () );
        System.out.println ("***serial"+serial);
        return null;
    }
}
```

```java
@RestController
public class SendMessageController {
    @Resource
    private IMessageProvider messageProvider;
    @GetMapping("/sendMessage")
    public String sendMessage(){
        return messageProvider.send ();
    }
}
```



### æ¶ˆæ¯é©±åŠ¨ä¹‹æ¶ˆè´¹è€…

```yml
spring:
  cloud:
    stream:
      binders: # åœ¨æ­¤å¤„é…ç½®è¦ç»‘å®šçš„RabbitMQçš„æœåŠ¡ä¿¡æ¯
        defaultRabbit: # è¡¨ç¤ºå®šä¹‰çš„åç§°ï¼Œç”¨äºbindingæ•´åˆ
          type: rabbit # æ¶ˆæ¯ç»„ä»¶ç±»å‹
          environment: # è®¾ç½®rabbitmqç›¸å…³ç¯å¢ƒé…ç½®
            spring:
              rabbitmq:
                host: localhost
                port: 5672
                username: guest
                password: guest
      bindings: # æœåŠ¡çš„æ•´åˆå¤„ç†
        input: # è¿™ä¸ªåå­—æ˜¯ä¸€ä¸ªé€šé“çš„åç§°
          destination: studyExchange # è¡¨ç¤ºè¦ä½¿ç”¨çš„Exchangeåç§°å®šä¹‰
          content-type: application/json # è®¾ç½®æ¶ˆæ¯ç±»å‹ï¼Œæœ¬æ¬¡ä¸ºjson,æ–‡æœ¬åˆ™è®¾ç½®â€œtext/jsonâ€
          binder: {defaultRabbit} # è®¾ç½®è¦ç»‘å®šçš„æ¶ˆæ¯æœåŠ¡çš„å…·ä½“è®¾ç½®
          group: consumerA

```



```java
@Component
@EnableBinding(Sink.class)
public class ReceiveMessageController {
    @Value("${server.port}")
    private String serverPort;
    @StreamListener(Sink.INPUT)
    public void input(Message<String> message){
        System.out.println ("æ¶ˆè´¹è€…1å·"+message.getPayload ()+"\t"+serverPort);
    }

}
```

### åˆ†ç»„æ¶ˆè´¹ä¸æŒä¹…åŒ–

> åˆ†ç»„group
>
> - å¯ä»¥é¿å…é‡å¤æ¶ˆè´¹
>
> - å¯ä»¥å®ç°æŒä¹…åŒ–ï¼Œé˜²æ­¢æ¶ˆæ¯ä¸¢å¤±

```yml
group: consumerA
```

## 16 SpringCloud Sleuthåˆ†å¸ƒå¼è¯·æ±‚é“¾è·¯è·Ÿè¸ª

### æ¦‚è¿°

> æ¯ä¸€ä¸ªå‰ç«¯è¯·æ±‚éƒ½ä¼šå½¢æˆä¸€æ¡å¤æ‚çš„åˆ†å¸ƒå¼æœåŠ¡è°ƒç”¨é“¾è·¯ï¼Œé“¾è·¯ä¸­ä»»ä½•ä¸€ç¯å‡ºç°é«˜å»¶æ—¶æˆ–è€…é”™è¯¯éƒ½ä¼šå¼•èµ·æ•´ä¸ªè¯·æ±‚æœ€åçš„å¤±è´¥

### æ­å»ºé“¾è·¯ç›‘æ§æ­¥éª¤

ä¸‹è½½https://repo1.maven.org/maven2/io/zipkin/java/zipkin-server/2.12.9/zipkin-server-2.12.9-exec.jar

å¯åŠ¨java -jar zipkinâ€¦

æ‰“å¼€http://localhost:9411/zipkin

Traceï¼šç±»ä¼¼äºæ ‘ç»“æ„çš„Spané›†åˆï¼Œè¡¨ç¤ºä¸€æ¡è°ƒç”¨é“¾è·¯ï¼Œå­˜åœ¨å”¯ä¸€è¡¨ç¤º

Spanï¼šè¡¨ç¤ºè°ƒç”¨é“¾è·¯æ¥æºï¼Œé€šä¿—çš„ç†è§£spanå°±æ˜¯ä¸€æ¬¡è¯·æ±‚ä¿¡æ¯

> è¦å¼€å¯é“¾è·¯ç›‘æ§çš„è¦åŠ pomå’Œymlé…ç½®

```yml
 zipkin:
    base-url: http://localhost:9411
  sleuth:
    sampler:
      probability: 1
```

80è°ƒç”¨8001ï¼ˆControlleræ–¹æ³•ç•¥ï¼‰ï¼Œé€šè¿‡http://localhost:9411/zipkinæŸ¥çœ‹

## 17 SpringCloud Alibabaå…¥é—¨ç®€ä»‹

### ä¸»è¦åŠŸèƒ½

- **æœåŠ¡é™æµé™çº§**ï¼šé»˜è®¤æ”¯æŒ WebServletã€WebFlux, OpenFeignã€RestTemplateã€Spring Cloud Gateway, Zuul, Dubbo å’Œ RocketMQ é™æµé™çº§åŠŸèƒ½çš„æ¥å…¥ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶é€šè¿‡æ§åˆ¶å°å®æ—¶ä¿®æ”¹é™æµé™çº§è§„åˆ™ï¼Œè¿˜æ”¯æŒæŸ¥çœ‹é™æµé™çº§ Metrics ç›‘æ§ã€‚
- **æœåŠ¡æ³¨å†Œä¸å‘ç°**ï¼šé€‚é… Spring Cloud æœåŠ¡æ³¨å†Œä¸å‘ç°æ ‡å‡†ï¼Œé»˜è®¤é›†æˆäº† Ribbon çš„æ”¯æŒã€‚
- **åˆ†å¸ƒå¼é…ç½®ç®¡ç†**ï¼šæ”¯æŒåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å¤–éƒ¨åŒ–é…ç½®ï¼Œé…ç½®æ›´æ”¹æ—¶è‡ªåŠ¨åˆ·æ–°ã€‚
- **æ¶ˆæ¯é©±åŠ¨èƒ½åŠ›**ï¼šåŸºäº Spring Cloud Stream ä¸ºå¾®æœåŠ¡åº”ç”¨æ„å»ºæ¶ˆæ¯é©±åŠ¨èƒ½åŠ›ã€‚
- **åˆ†å¸ƒå¼äº‹åŠ¡**ï¼šä½¿ç”¨ @GlobalTransactional æ³¨è§£ï¼Œ é«˜æ•ˆå¹¶ä¸”å¯¹ä¸šåŠ¡é›¶ä¾µå…¥åœ°è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ã€‚
- **é˜¿é‡Œäº‘å¯¹è±¡å­˜å‚¨**ï¼šé˜¿é‡Œäº‘æä¾›çš„æµ·é‡ã€å®‰å…¨ã€ä½æˆæœ¬ã€é«˜å¯é çš„äº‘å­˜å‚¨æœåŠ¡ã€‚æ”¯æŒåœ¨ä»»ä½•åº”ç”¨ã€ä»»ä½•æ—¶é—´ã€ä»»ä½•åœ°ç‚¹å­˜å‚¨å’Œè®¿é—®ä»»æ„ç±»å‹çš„æ•°æ®ã€‚
- **åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦**ï¼šæä¾›ç§’çº§ã€ç²¾å‡†ã€é«˜å¯é ã€é«˜å¯ç”¨çš„å®šæ—¶ï¼ˆåŸºäº Cron è¡¨è¾¾å¼ï¼‰ä»»åŠ¡è°ƒåº¦æœåŠ¡ã€‚åŒæ—¶æä¾›åˆ†å¸ƒå¼çš„ä»»åŠ¡æ‰§è¡Œæ¨¡å‹ï¼Œå¦‚ç½‘æ ¼ä»»åŠ¡ã€‚ç½‘æ ¼ä»»åŠ¡æ”¯æŒæµ·é‡å­ä»»åŠ¡å‡åŒ€åˆ†é…åˆ°æ‰€æœ‰ Workerï¼ˆschedulerx-clientï¼‰ä¸Šæ‰§è¡Œã€‚
- **é˜¿é‡Œäº‘çŸ­ä¿¡æœåŠ¡**ï¼šè¦†ç›–å…¨çƒçš„çŸ­ä¿¡æœåŠ¡ï¼Œå‹å¥½ã€é«˜æ•ˆã€æ™ºèƒ½çš„äº’è”åŒ–é€šè®¯èƒ½åŠ›ï¼Œå¸®åŠ©ä¼ä¸šè¿…é€Ÿæ­å»ºå®¢æˆ·è§¦è¾¾é€šé“ã€‚

### ç»„ä»¶

**[Sentinel](https://github.com/alibaba/Sentinel)**ï¼šæŠŠæµé‡ä½œä¸ºåˆ‡å…¥ç‚¹ï¼Œä»æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ã€ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤ç­‰å¤šä¸ªç»´åº¦ä¿æŠ¤æœåŠ¡çš„ç¨³å®šæ€§ã€‚

**[Nacos](https://github.com/alibaba/Nacos)**ï¼šä¸€ä¸ªæ›´æ˜“äºæ„å»ºäº‘åŸç”Ÿåº”ç”¨çš„åŠ¨æ€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’ŒæœåŠ¡ç®¡ç†å¹³å°ã€‚

**[RocketMQ](https://rocketmq.apache.org/)**ï¼šä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿï¼ŒåŸºäºé«˜å¯ç”¨åˆ†å¸ƒå¼é›†ç¾¤æŠ€æœ¯ï¼Œæä¾›ä½å»¶æ—¶çš„ã€é«˜å¯é çš„æ¶ˆæ¯å‘å¸ƒä¸è®¢é˜…æœåŠ¡ã€‚

**[Dubbo](https://github.com/apache/dubbo)**ï¼šApache Dubboâ„¢ æ˜¯ä¸€æ¬¾é«˜æ€§èƒ½ Java RPC æ¡†æ¶ã€‚

**[Seata](https://github.com/seata/seata)**ï¼šé˜¿é‡Œå·´å·´å¼€æºäº§å“ï¼Œä¸€ä¸ªæ˜“äºä½¿ç”¨çš„é«˜æ€§èƒ½å¾®æœåŠ¡åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚

**[Alibaba Cloud OSS](https://www.aliyun.com/product/oss)**: é˜¿é‡Œäº‘å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼ˆObject Storage Serviceï¼Œç®€ç§° OSSï¼‰ï¼Œæ˜¯é˜¿é‡Œäº‘æä¾›çš„æµ·é‡ã€å®‰å…¨ã€ä½æˆæœ¬ã€é«˜å¯é çš„äº‘å­˜å‚¨æœåŠ¡ã€‚æ‚¨å¯ä»¥åœ¨ä»»ä½•åº”ç”¨ã€ä»»ä½•æ—¶é—´ã€ä»»ä½•åœ°ç‚¹å­˜å‚¨å’Œè®¿é—®ä»»æ„ç±»å‹çš„æ•°æ®ã€‚

**[Alibaba Cloud SchedulerX](https://help.aliyun.com/document_detail/43136.html)**: é˜¿é‡Œä¸­é—´ä»¶å›¢é˜Ÿå¼€å‘çš„ä¸€æ¬¾åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦äº§å“ï¼Œæä¾›ç§’çº§ã€ç²¾å‡†ã€é«˜å¯é ã€é«˜å¯ç”¨çš„å®šæ—¶ï¼ˆåŸºäº Cron è¡¨è¾¾å¼ï¼‰ä»»åŠ¡è°ƒåº¦æœåŠ¡ã€‚

**[Alibaba Cloud SMS](https://www.aliyun.com/product/sms)**: è¦†ç›–å…¨çƒçš„çŸ­ä¿¡æœåŠ¡ï¼Œå‹å¥½ã€é«˜æ•ˆã€æ™ºèƒ½çš„äº’è”åŒ–é€šè®¯èƒ½åŠ›ï¼Œå¸®åŠ©ä¼ä¸šè¿…é€Ÿæ­å»ºå®¢æˆ·è§¦è¾¾é€šé“ã€‚

## 18 SpringCloud Alibaba NacosæœåŠ¡æ³¨å†Œå’Œé…ç½®ä¸­å¿ƒ

### ç®€ä»‹

Nacos=Eureka+Config+Bus

æ›¿ä»£EurekaåšæœåŠ¡æ³¨å†Œä¸­å¿ƒ

æ›¿ä»£ConfigåšæœåŠ¡é…ç½®ä¸­å¿ƒ

### å®‰è£…å¹¶è¿è¡Œ

éœ€è¦å°†conf/nacos-mysql.sqlæ–‡ä»¶åœ¨Mysqlä¸­è¿è¡Œ

å¯åŠ¨nacos-server.cmd

### Nacosä½œä¸ºæœåŠ¡æ³¨å†Œä¸­å¿ƒæ¼”ç¤º

```xml
<dependency>
  <groupId>com.alibaba.cloud</groupId>
  <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

Nacosä½œä¸ºæœåŠ¡æä¾›è€…

```yml
server:
  port: 9001
spring:
  application:
    name: nacos-payment-provider
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
management:
  endpoints:
    web:
      exposure:
        include: "*"
```

æ‹·è´è´Ÿè½½å‡è¡¡çš„cloudalibaba-provider-payment9001 ![1623037575531](.\images\1623037575531.png)

> nacosAPå’ŒCPåˆ‡æ¢ï¼š`curl -X PUT '$NACOS_SERVER:8848/nacos/v1/ns/operator/switches?entry=serverMode&value=CP'`

![image-20230816203933409](./images/image-20230816203933409.png)

### Nacosä½œä¸ºæœåŠ¡é…ç½®ä¸­å¿ƒæ¼”ç¤º

```yml
server:
  port: 3377
spring:
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
      config:
        server-addr: localhost:8848
        file-extension: yaml
```



è®¾ç½®DataId:{spring.application.name}-{spring.profiles.active}.{spring.cloud.nacos.config.file-extension}

![1623385484272](.\images\1623385484272.png)

```java
@RestController
@RefreshScope //æ”¯æŒnacosçš„åŠ¨æ€åˆ·æ–°åŠŸèƒ½
public class ConfigClientController {
    @Value("${config.info}")
    private String configInfo;

    @GetMapping("/config/info")
    public String getConfigInfo(){
        return configInfo;
       
    }
}
```

æœåŠ¡é…ç½®ä¸­å¿ƒ-åˆ†ç±»é…ç½®

![1623386127833](.\images\1623386127833.png)

åˆ†ç»„Group

![1623386542157](.\images\1623386542157.png)

å‘½åç©ºé—´Namespace

![1623386656447](.\images\1623386656447.png)



> å‘½åç©ºé—´ç”¨æ¥åŒºåˆ†å¾®æœåŠ¡ï¼Œåˆ†ç»„ç”¨æ¥åŒºåˆ†ç¯å¢ƒ

é…ç½®å¤šé…ç½®æ–‡ä»¶

```properties
spring.cloud.nacos.config.extension-configs[0].data-id=datasource.yml
spring.cloud.nacos.config.extension-configs[0].group=dev
spring.cloud.nacos.config.extension-configs[0].refresh=true

spring.cloud.nacos.config.extension-configs[1].data-id=mybatis.yml
spring.cloud.nacos.config.extension-configs[1].group=dev
spring.cloud.nacos.config.extension-configs[1].refresh=true

spring.cloud.nacos.config.extension-configs[2].data-id=other.yml
spring.cloud.nacos.config.extension-configs[2].group=dev
spring.cloud.nacos.config.extension-configs[2].refresh=true
```



### Nacosé›†ç¾¤å’ŒæŒä¹…åŒ–é…ç½®

é›†ç¾¤é…ç½®ï¼šhttps://nacos.io/zh-cn/docs/deployment.html

![1638516818578](images/1638516818578.png)

### Nacosä¸å…¶ä»–æ³¨å†Œä¸­å¿ƒç‰¹æ€§å¯¹æ¯”

![1638448298234](images/1638448298234.png)

## 19 Sentinelç†”æ–­é™çº§

### ç®€ä»‹

åŠŸèƒ½åŒhystrix

### å®‰è£…å¹¶å¯åŠ¨Sentinelæ§åˆ¶å°

ä¸‹è½½sentinel dashboard.jar å¹¶java -jarè¿è¡Œ

æµè§ˆå™¨http://localhost:8080è®¿é—®ï¼Œè´¦å·å¯†ç sentinel

### åˆå§‹åŒ–æ¼”ç¤ºå·¥ç¨‹

```xml
<dependency>
  <groupId>com.alibaba.cloud</groupId>
  <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>

<dependency>
  <groupId>com.alibaba.csp</groupId>
  <artifactId>sentinel-datasource-nacos</artifactId>
</dependency>
<dependency>
  <groupId>com.alibaba.cloud</groupId>
  <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
</dependency>

<!-- https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-starter-openfeign -->
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-openfeign</artifactId>
  <version>2.2.6.RELEASE</version>
</dependency>
<dependency>
  <groupId>com.binyu </groupId>
  <artifactId>cloud-api-commons</artifactId>
  <version>${project.version}</version>
</dependency>
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-web</artifactId>
</dependency>
```



```yml
server:
  port: 8401
spring:
  application:
    name: cloudalibaba-sentinel-service
  datasource:
    # å½“å‰æ•°æ®æºæ“ä½œç±»å‹
    type: com.alibaba.druid.pool.DruidDataSource
    # mysqlé©±åŠ¨ç±»
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/2021study-springcloud?useUnicode=true&characterEncoding=UTF-8&useSSL=false&serverTimezone=GMT%2B8
    username: root
    password: root
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
    sentinel:
      transport:
        # é…ç½®sentinel dashboardåœ°å€
        dashboard: localhost:8080
        # é»˜è®¤8719ç«¯å£ï¼ŒåŠ å…¥è¢«å ç”¨è‡ªåŠ¨ä»8719å¼€å§‹ä¾æ¬¡+1æ‰«æ
        port: 8719

management:
  endpoints:
    web:
      exposure:
        include: "*"
```

### æµæ§è§„åˆ™

æµæ§:æµé‡æ§åˆ¶

![1623477832440](.\images\1623477832440.png)

æµæ§æ¨¡å¼ï¼š

- ç›´æ¥
- å…³è”ï¼ˆå¤§æ‰¹é‡è®¿é—®Bï¼Œç»“æœAæŒ‚äº†ï¼‰
- é“¾è·¯

æµæ§æ•ˆæœï¼š

- ç›´æ¥å¤±è´¥
- é¢„çƒ­ï¼ˆå³è¯·æ±‚ä»threshold/3å¼€å§‹é¢„çƒ­ï¼‰
- æ’é˜Ÿç­‰å¾…ï¼ˆåŒ€é€Ÿé€šè¿‡ï¼‰

### é™çº§è§„åˆ™

- RTï¼ˆå¹³å‡å“åº”æ—¶é—´è¶…å‡ºé˜ˆå€¼ä¸”æ—¶é—´çª—å£å†…é€šè¿‡çš„è¯·æ±‚>=5ï¼Œä¸¤ä¸ªæ¡ä»¶åŒæ—¶æ»¡è¶³åè§¦å‘é™çº§ï¼‰

![1623479958100](.\images\1623479958100.png)

- å¼‚å¸¸æ¯”ä¾‹ï¼ˆç§’çº§ QPS>=5ä¸”å¼‚å¸¸æ¯”ä¾‹ï¼ˆç§’çº§ç»Ÿè®¡ï¼‰è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œè§¦å‘é™çº§ï¼‰

> Ramp-up Periodï¼ˆin secondsï¼‰
>
> ã€1ã€‘å†³å®šå¤šé•¿æ—¶é—´å¯åŠ¨æ‰€æœ‰çº¿ç¨‹ã€‚å¦‚æœä½¿ç”¨10ä¸ªçº¿ç¨‹ï¼Œramp-up periodæ˜¯100ç§’ï¼Œé‚£ä¹ˆJMeterç”¨100ç§’ä½¿æ‰€æœ‰10ä¸ªçº¿ç¨‹å¯åŠ¨å¹¶è¿è¡Œã€‚

- å¼‚å¸¸æ•°ï¼ˆåˆ†é’Ÿç»Ÿè®¡ï¼Œè¶…è¿‡é˜ˆå€¼åï¼Œè§¦å‘é™çº§ï¼‰

Sentinelæ²¡æœ‰åŠå¼€çŠ¶æ€

### çƒ­ç‚¹Keyé™æµ

@SentinelResource(value=â€œtestHotKeyâ€,blockHandler=â€œdealHandler_testHotKeyâ€)

ç”¨æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„é™çº§æ–¹æ³•

> @SentinelResourceå¤„ç†çš„æ˜¯Sentinelæ§åˆ¶å°é…ç½®çš„è¿è§„æƒ…å†µï¼Œæœ‰blockHandleræ–¹æ³•é…ç½®çš„å…œåº•å¤„ç†
>
> RuntimeException int age=10/0;è¿™ä¸ªæ˜¯javaè¿è¡Œæ—¶çˆ†å‡ºçš„è¿è¡Œæ—¶å¼‚å¸¸ï¼Œ@SentinelResourceä¸ç®¡

### ç³»ç»Ÿè§„åˆ™

å…¥å£çº§åˆ«

![1623481638473](.\images\1623481638473.png)

### @SentinelResource

![1623482737673](.\images\1623482737673.png)

### æœåŠ¡ç†”æ–­åŠŸèƒ½

fallbackç®¡è¿è¡Œå¼‚å¸¸

blockHandlerç®¡é…ç½®è¿è§„

ä¸¤ä¸ªéƒ½é…ï¼Œéƒ½å‘ç”Ÿï¼Œå°±åªblockHandler

![1638602818572](images/1638602818572.png)

æ¿€æ´»Sentinelå¯¹feignçš„æ”¯æŒï¼Œæ­¤æ—¶@FeignClientçš„fallbackåº•å±‚å®ç°æ˜¯sentinel

![1638602931869](images/1638602931869.png)



### è§„åˆ™æŒä¹…åŒ–

![1638603387166](images/1638603387166.png)

![1623562564183](.\images\1623562564183.png)

![1623562599291](.\images\1623562599291.png)

## 20 Seataåˆ†å¸ƒå¼äº‹åŠ¡

### åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜

è·¨å¤šä¸ªæ•°æ®åº“ï¼Œå…¨å±€æ•°æ®ä¸€è‡´æ€§é—®é¢˜æ²¡æ³•ä¿è¯

### ç®€ä»‹

åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ

[SEATAå®˜ç½‘](https://seata.io/zh-cn/)

åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†è¿‡ç¨‹çš„1ID+3ç»„ä»¶æ¨¡å‹ï¼š

Transaction ID XID å…¨å±€å”¯ä¸€çš„äº‹åŠ¡ID

Transaction Coordinator TC-äº‹åŠ¡åè°ƒå™¨ï¼Œç»´æŠ¤å…¨å±€äº‹åŠ¡çš„è¿è¡ŒçŠ¶æ€ï¼Œè´Ÿè´£åè°ƒå¹¶é©±åŠ¨å…¨å±€äº‹åŠ¡çš„æäº¤

Transaction Manager TM-æ§åˆ¶å…¨å±€äº‹åŠ¡çš„è¾¹ç•Œï¼Œè´Ÿè´£å¼€å¯ä¸€ä¸ªå…¨å±€äº‹åŠ¡ï¼Œå¹¶æœ€ç»ˆå‘èµ·å…¨å±€æäº¤æˆ–è€…å…¨å±€å›æ»šçš„å†³è®®

Resource Manager RM-æ§åˆ¶åˆ†æ”¯äº‹åŠ¡ï¼Œè´Ÿè´£åˆ†æ”¯æ³¨å†Œã€çŠ¶æ€æ±‡æŠ¥ï¼Œå¹¶æ¥æ”¶äº‹åŠ¡åè°ƒå™¨çš„æŒ‡ä»¤ï¼Œé©±åŠ¨åˆ†æ”¯ï¼ˆæœ¬åœ°ï¼‰äº‹åŠ¡çš„æäº¤å’Œå›æ»š

![1623563698455](.\images\1623563698455.png)

### ä¸‰ä¸ªå¾®æœåŠ¡æ•°æ®åº“æ­å»º

æ¯ä¸ªæ•°æ®åº“éƒ½è¦å»ºç«‹å„è‡ªçš„å›æ»šæ—¥å¿—è¡¨

![1638604972296](images/1638604972296.png)



ä¿®æ”¹file.conf ç¡®å®šç»„ï¼Œå¹¶ä¿®æ”¹æ•°æ®åº“é…ç½®ã€‚å¹¶ä¿®æ”¹register.conf ã€‚å¹¶å¤åˆ¶è¿™ä¸¤ä¸ªæ–‡ä»¶åˆ°é¡¹ç›®çš„resourcesä¸‹

![1638605347880](images/1638605347880.png)

![1638605707535](images/1638605707535.png)

![1638605761221](images/1638605761221.png)

![1638605635907](images/1638605635907.png)

configé…ç½®

![1638606001821](images/1638606001821.png)

```java
@Configuration
public class DataSourceProxyConfig {
@Value("${mybatis.mapper-locations}")
private String mapperLocations;
@Bean
@ConfigurationProperties(prefix = "spring.datasource")
public DataSource druidDataSource(){
    return new DruidDataSource();
}
@Bean
public DataSourceProxy dataSourceProxy(DataSource dataSource) {
    return new DataSourceProxy(dataSource);
}
@Bean
public SqlSessionFactory sqlSessionFactoryBean(DataSourceProxy dataSourceProxy) throws Exception {
    SqlSessionFactoryBean sqlSessionFactoryBean = new SqlSessionFactoryBean();
    sqlSessionFactoryBean.setDataSource(dataSourceProxy);
    sqlSessionFactoryBean.setMapperLocations(new PathMatchingResourcePatternResolver().getResources(mapperLocations));
    sqlSessionFactoryBean.setTransactionFactory(new SpringManagedTransactionFactory());
    return sqlSessionFactoryBean.getObject();
}
} 
```

 ä¸è¦å¿˜è®°åœ¨ä¸»å¯åŠ¨ç±»æ·»åŠ (exclude = DataSourceAutoConfiguration.class)å–æ¶ˆæ•°æ®æºçš„è‡ªåŠ¨é…ç½® 



`@GlobalTransactional(name=â€œfsp-create-orderâ€,rollbackFor=Exception.class)`

rollbackForå“ªäº›å¼‚å¸¸å‡ºç°éœ€è¦å›æ»š

![1623565539981](.\images\1623565539981.png)

### SeataåŸç†

![1638606718545](images/1638606718545.png)

## è¸©å‘å®å½•

### nacosé›†ç¾¤è¸©å‘-cluster.confé…ç½®localhostä¸èµ·ä½œç”¨ï¼Œè¦é…ç½®æœ¬æœºIP

[nacosé›†ç¾¤è¸©å‘-cluster.confé…ç½®æœ¬æœºIP](https://blog.csdn.net/xujunming668/article/details/122518073)

```
server:
  port: 8088
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/cloud-order?useSSL=false
    username: root
    password: root
    driver-class-name: com.mysql.jdbc.Driver
  application:
    name: order-service
  cloud:
    nacos:
      server-addr: localhost:80 # nacosæœåŠ¡åœ°å€
#      discovery:
#        namespace: 4d6ce343-9e1b-44df-a90f-2cf2b6b3d177 # devç¯å¢ƒ
#        ephemeral: false # æ˜¯å¦æ˜¯ä¸´æ—¶å®ä¾‹
mybatis:
  type-aliases-package: cn.itcast.user.pojo
  configuration:
    map-underscore-to-camel-case: true
logging:
  level:
    cn.itcast: debug
  pattern:
    dateformat: MM-dd HH:mm:ss:SSS
#eureka:
#  client:
#    service-url:  # eurekaçš„åœ°å€ä¿¡æ¯
#      defaultZone: http://127.0.0.1:10086/eureka
user-service:
  ribbon:
    NFLoadBalancerRuleClassName: com.alibaba.cloud.nacos.ribbon.NacosRule  # è´Ÿè½½å‡è¡¡è§„åˆ™
ribbon:
  eager-load:
    enabled: true # å¼€å¯é¥¥é¥¿åŠ è½½
    clients: # æŒ‡å®šé¥¥é¥¿åŠ è½½çš„æœåŠ¡åç§°
      - user-service
feign:
  httpclient:
    enabled: true # æ”¯æŒHttpClientçš„å¼€å…³
    max-connections: 200 # æœ€å¤§è¿æ¥æ•°
    max-connections-per-route: 50 # å•ä¸ªè·¯å¾„çš„æœ€å¤§è¿æ¥æ•°
```

### macä¸èƒ½ç›´æ¥è¿›å…¥æ•°æ®å·æŒ‚è½½ç›®å½•ï¼Œè¿è¡Œä¸‹é¢çš„å‘½ä»¤å°±è¡Œäº†

mac docker æ•°æ®å·ä¸èƒ½ç›´æ¥è¿›å…¥ï¼Œéœ€è¦ä½¿ç”¨debiané•œåƒè¿æ¥è¿›å…¥

ç›´æ¥è¿›å…¥ä¼šæç¤ºæ–‡ä»¶å¤¹ä¸å­˜åœ¨

```
cd /var/lib/docker/volumes/html/_data
-bash: cd: /var/lib/docker/volumes/html/_data: No such file or directory
```

è§£å†³æ–¹æ³•ï¼š

```
$ docker run -it --privileged --pid=host debian nsenter -t 1 -m -u -n -i sh
$ cd /var/lib/docker/volumes
```

### åˆ‡æ¢åˆ°rootç”¨æˆ·

```bash
sudo su -
```

### mysql docker

```
sudo docker run --name mysql -e MYSQL_ROOT_PASSWORD=ROOT1234 \
-p 3306:3306 \
-v /tmp/mysql/conf/hmy.cnf:/etc/mysql/conf.d/hmy.cnf \
-v /tmp/mysql/data:/var/lib/mysql \
-d mysql
```

